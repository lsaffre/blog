:date: 2025-01-18

================================
Playing with Ibanity (continued)
================================

Saturday, January 18, 2025

I continued to play with Ibanity, based on what I learned :doc:`some days ago
<0114>`. I successfully requested `an access token
<https://documentation.ibanity.com/einvoicing/1/api/curl#request-access-token>`__,
but how can I use this to send an outbound invoice? I do have an XML file
generated by TIM or Lino as described in `Lino and eInvoicing (PEPPOL)
<https://dev.lino-framework.org/topics/peppol.html>`__.

Here is the script I used today:

.. literalinclude:: 0118.py

When ``EXAMPLE`` is `1` in this script, it asks for a list of suppliers.
And this works. Here is the output ::

  {'data': [{'attributes': {'city': 'Leuven',
                            'companyNumber': '1234567890',
                            'contactEmail': 'contact@example.be',
                            'country': 'Belgium',
                            'createdAt': '2025-01-18T15:10:56.719813Z',
                            'email': 'someone@example.be',
                            'enterpriseIdentification': {'enterpriseNumber': '1234567890',
                                                         'vatNumber': 'BE1234567890'},
                            'homepage': 'www.home.com',
                            'ibans': [{'id': 'bdfa52c6-2b50-4690-8b8d-24541a92c578',
                                       'value': 'BE68539007547034'},
                                      {'id': 'dcb9f7c2-be2c-4b52-8d77-3ed2bc05c5f8',
                                       'value': 'BE68539007547034'}],
                            'names': [{'id': '3dffba33-97af-4477-9fab-2d9d2dc31cee',
                                       'value': 'Company'},
                                      {'id': '99e410cc-d6f0-4f36-8096-949741ea8ec3',
                                       'value': 'Company S.A.'}],
                            'onboardingStatus': 'CREATED',
                            'peppolReceiver': False,
                            'phoneNumber': '+3254321121',
                            'street': 'Street',
                            'streetNumber': '2',
                            'supportEmail': 'support@example.be',
                            'supportPhone': '+3212345121',
                            'supportUrl': 'www.support.com',
                            'zip': '3000'},
             'id': '273c1bdf-6258-4484-b6fb-74363721d51f',
             'type': 'supplier'}],
   'meta': {'paging': {'number': 0, 'size': 2000, 'total': 1}}}

But until further notice I hope that TIM doesn't need to care about suppliers
because our users will use their online banking application to see their
purchase invoices, and they will simply enter them manually into TIM as they are
used to do right now.

What TIM users will need to do is a check whether their customer exists. That's
documented in `Peppol Customer Search
<https://documentation.ibanity.com/einvoicing/1/api/curl#peppol-customer-search>`__.

Today's script does exactly this when ``EXAMPLE`` is `2`. But until now I always
get 400 (Bad Request)::

  Customer search
  {'attributes': {'customerReference': '9925:BE0010012671'},
   'type': 'peppolCustomerSearch'}
  Traceback (most recent call last):
    File ".../0118.py", line 93, in <module>
      raise Exception(f"Unexpected status code {response.status_code} for POST {url}")
  Exception: Unexpected status code 400 for POST https://api.ibanity.com/einvoicing/customer-searches

What am I missing?

..
  When this works, my next step will be to send a sales invoice, as documented in
  `Peppol Outbound Invoice
  <https://documentation.ibanity.com/einvoicing/1/api/curl#peppol-outbound-invoice>`__
