<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20100116 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2010" href="index.html" />
    <link rel="next" title="20100118" href="0118.html" />
    <link rel="prev" title="&lt;no title&gt;" href="0114.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0118.html" title="20100118"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0114.html" title="&lt;no title&gt;"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2010</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20100116<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="stammdaten-nur-fur-eingeloggte-user-sichtbar">
<h2>Stammdaten nur für eingeloggte User sichtbar<a class="headerlink" href="#stammdaten-nur-fur-eingeloggte-user-sichtbar" title="Permalink to this headline">¶</a></h2>
<p>Ich lass momentan bewusst die Companies (Organisationen) mal für alle sichtbar, weil ich dann ein bisschen experimentieren kann. can_view würde ich ja gerne auch pro Model setzen können, aber da muss ich erst mal nachschauen, inwiefern Djangos Meta-Klasse erweiterbar ist.</p>
<p>Weil <cite>load_tim.py</cite> jetzt auch die Benutzer aus TIM importiert, könnte
ich mich ja mal als LUC statt immer nur der doofe &#8220;user&#8221;
einloggen. Aber oh, Login für Benutzer ohne Passwort funktioniert
nicht:</p>
<div class="highlight-python"><div class="highlight"><pre>Traceback (most recent call last):
  File &quot;c:\drives\t\hgwork\lino\src\lino\actions.py&quot;, line 90, in run
    self.action.run(self,*self._args,**self._kw)
  File &quot;c:\drives\t\hgwork\lino\src\lino\modlib\system\models.py&quot;, line 97, in run
    _(&quot;Please enter a correct username and password. Note that both fields are case-sensitive.&quot;))
ValidationError: &lt;unprintable ValidationError object&gt;
Traceback (most recent call last):
  File &quot;l:\snapshot\django\django\core\servers\basehttp.py&quot;, line 280, in run
    self.result = application(self.environ, self.start_response)
  File &quot;l:\snapshot\django\django\core\servers\basehttp.py&quot;, line 672, in __call__
    return self.application(environ, start_response)
  File &quot;l:\snapshot\django\django\core\handlers\wsgi.py&quot;, line 241, in __call__
    response = self.get_response(request)
  File &quot;l:\snapshot\django\django\core\handlers\base.py&quot;, line 143, in get_response
    return self.handle_uncaught_exception(request, resolver, exc_info)
  File &quot;l:\snapshot\django\django\core\handlers\base.py&quot;, line 101, in get_response
    response = callback(request, *callback_args, **callback_kwargs)
  File &quot;c:\drives\t\hgwork\lino\src\lino\ui\extjs.py&quot;, line 1987, in act_view
    context.run()
  File &quot;c:\drives\t\hgwork\lino\src\lino\actions.py&quot;, line 95, in run
    self.response.update(msg=str(e),success=False)
UnicodeEncodeError: &#39;ascii&#39; codec can&#39;t encode character u&#39;\xfc&#39; in position 13: ordinal not in range(128)
</pre></div>
</div>
<p>Also wir kommen voll in ins Thema Internationalisierung rein, denn
wenn ich den Unterstrich vor der Fehlermeldung <cite>_(&#8220;Please enter a
correct username and password. Note that both fields are
case-sensitive.&#8221;))</cite> weg tue, dann klappt es (d.h. die Fehlermeldung
wird angezeigt). Der Fehler kommt, weil Django automagisch den
englischen text nach Deutsch übersetzt hat. Ein <cite>print repr(e)</cite> vor
Zeile 95 in actions.py lässt den Text <cite>ValidationError(u&#8217;Bitte einen
gxfcltigen Benutzernamen und ein Passwort eingeben. Beide Felder
berxfccksichtigen die Groxdf-/Kleinschreibung.&#8217;,)</cite> auf der Konsole
erscheinen.  Wie kriege ich die deutsche Meldung angezeigt? Was mach
ich falsch?</p>
<p>Erst mal ein <cite>svn update</cite> für Django: <cite>Updated to revision 12231</cite>. Immerhin ist Django in der Alpha von 1.2. Dann mal die [<a class="reference external" href="http://docs.djangoproject.com/en/1.1/topics/i18n/#topics-i18n">http://docs.djangoproject.com/en/1.1/topics/i18n/#topics-i18n</a> Dokumentation über Djangos i18n] lesen. Hm... nützt alles nichts...</p>
<p>Also das ist eine Exception mit einer Meldung in Unicode.
Django-Ticket [<a class="reference external" href="http://code.djangoproject.com/ticket/6353">http://code.djangoproject.com/ticket/6353</a> 6353]
hatte da auch schon Probleme mit. Die haben das damals so gelöst:
[<a class="reference external" href="http://code.djangoproject.com/attachment/ticket/6353/6353-2.diff">http://code.djangoproject.com/attachment/ticket/6353/6353-2.diff</a>].</p>
<p>Tilt! Ich muss nicht <cite>unicode()</cite>, sondern Djangos <cite>force_unicode()</cite> benutzen.
Hier muss ich übrigens nicht <cite>smart_unicode()</cite> benutzen, weil mein JavaScript mit einem lazy translation string noch nichts anfangen könnte. Übersetzung findet momentan nur auf dem Server, nicht auf dem Client statt.</p>
<p>Voilà. Und dass man sich momentan noch nicht mit den TIM-Benutzernamen einloggen kann, weil die kein Passwort haben, das lass ich vorerst mal offen.</p>
<p>Habe <cite>allowBlank=False</cite> für das Feld Passwort gesetzt. Er umrahmt das
Feld zwar jetzt in Rot, wenn es leer ist, aber trotzdem schickt er den
Request ab. Eigentlich sollte er doch client validation machen. Hier
der momentane Code meines Login-Fensters:</p>
<div class="highlight-python"><div class="highlight"><pre>function(caller) {
  var text = { flex: 1, html: &quot;Please enter your username and password to authentificate.&quot;, xtype: &quot;label&quot; };
  this.username = { items: { flex: 1, fieldLabel: &quot;Benutzername&quot;, xtype: &quot;textfield&quot;, name: &quot;username&quot;, maxLength: 75, allowBlank: false }, layout: &quot;form&quot;, xtype: &quot;container&quot; };
  this.password = { items: { flex: 1, fieldLabel: &quot;Passwort&quot;, xtype: &quot;textfield&quot;, name: &quot;password&quot;, maxLength: 75, inputType: &quot;password&quot;, allowBlank: false }, layout: &quot;form&quot;, xtype: &quot;container&quot; };
  var cancel = { flex: 10, handler: Lino.form_action(this,&#39;cancel&#39;,&#39;/form/system/Login/cancel&#39;), xtype: &quot;button&quot;, text: &quot;Cancel&quot; };
  var ok = { flex: 10, handler: Lino.form_action(this,&#39;ok&#39;,&#39;/form/system/Login/ok&#39;), xtype: &quot;button&quot;, text: &quot;Login&quot; };
  this.main_4_panel = { flex: 1, border: false, layout: &quot;hbox&quot;, xtype: &quot;container&quot;, items: [ cancel, ok ], frame: false, layoutConfig: { align: &quot;stretch&quot; } };
  this.main_panel = new Ext.form.FormPanel({ border: false, autoHeight: false, layout: &quot;vbox&quot;, xtype: &quot;container&quot;, autoScroll: true, items: [ text, this.username, this.password, this.main_4_panel ], frame: true, layoutConfig: { align: &quot;stretch&quot; }, bodyBorder: false, labelAlign: &quot;left&quot; });
  this.comp = new Ext.Window( { layout: &quot;fit&quot;, title: null, items: this.main_panel, height: 178, width: 260, maximizable: true, maximized: false, y: 191, x: 341, tools: [ { handler: Lino.save_window_config(this,&#39;/save_win/system_Login&#39;), id: &quot;save&quot; } ], id: &quot;system_Login&quot; } );
  this.get_values = function() {
    var v = {};
    v[&#39;password&#39;] = this.main_panel.getForm().findField(&#39;password&#39;).getValue();
    v[&#39;username&#39;] = this.main_panel.getForm().findField(&#39;username&#39;).getValue();
    return v;
  };
  this.stop = function() {
     this.comp.close();
  }
  this.comp.show();
}
</pre></div>
</div>
<p>Und mein <cite>Lino.form_action()</cite> ruft <cite>Lino.do_action()</cite>, und der macht
ohne Wenn und Aber einen AJAX-Request. Daher kommt es. Allerdings
sollte der Cancel-Button ja auch funktionieren, wenn die Form nicht
gültig ausgefüllt ist. Also muss ich pro <cite>Action</cite> festlegen, ob sie
nur validierte Form data akzeptiert. Also ein neues Attribut
<cite>Action.needs_validation</cite>, das in actions.OK auf True gesetzt wird.</p>
<p>Schön wäre noch, wenn ich den defaultButton definieren könnte.
Neues Attribut <cite>Layout.default_element</cite> ist (wenn nicht None) ein String mit dem Namen des Default-Buttons. Und <cite>extjs.InputElement</cite> muss dann nur den <cite>id</cite> ebenfalls setzen.</p>
<p>Das funktioniert jetzt so, aber Problem: ExtJS versteht unter defaultButton die Komponente, die beim Öffnen den Fokus bekommen soll (&#8220;Specifies a Component to receive focus when this Window is focussed.&#8221;). Das ist ein irritierender Name. Unter &#8220;Default Button&#8221; verstehe ich was ganz anderes, nämlich den Button, der bei ENTER aktiviert werden soll.
Also Linos Layout.default_button soll gar nicht der <cite>Ext.Window.defaultButton</cite> werden.
Zum Glück hat Stephen Friedrich eine Lösung dafür geschrieben:
<a class="reference external" href="http://www.extjs.com/forum/showthread.php?t=87273">http://www.extjs.com/forum/showthread.php?t=87273</a>
Für mich das erste Mal, dass ich ein ExtJS-Plugin benutze. Eingebaut und Plupp, es funktioniert! Höchstens noch schade, dass der defaultButton nicht als solche erkennbar ist (weil er keinen verbreiterten Rand hat). Aber jetzt muss ich Feierabend machen.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0118.html" title="20100118"
             >next</a> |</li>
        <li class="right" >
          <a href="0114.html" title="&lt;no title&gt;"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2010</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2010/0116.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2010/0116.html">Online Link</a>
    </div>
  </body>
</html>