<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20101001 Notizen einfügen &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2010" href="index.html" />
    <link rel="next" title="20101004" href="1004.html" />
    <link rel="prev" title="20100930 disabled fields" href="0930.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="1004.html" title="20101004"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0930.html" title="20100930 disabled fields"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2010</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="notizen-einfugen">
<h1>20101001 Notizen einfügen<a class="headerlink" href="#notizen-einfugen" title="Permalink to this headline">¶</a></h1>
<p><strong>(3.17 Uhr)</strong>
<a class="reference external" href="http://www.lino-framework.org/api/lino.utils.jsgen.html#lino.utils.jsgen.py2js" title="(in Lino v1.6)"><code class="xref py py-func docutils literal"><span class="pre">lino.utils.jsgen.py2js()</span></code></a> hatte einen Bug: Datumswerte wurden um einen Monat verschoben. (Denn ich hatte noch nicht mitbekommen, dass der Parameter <cite>month</cite> bei 0 anfängt, wenn man in Javascript ein Datum mit <code class="docutils literal"><span class="pre">new</span> <span class="pre">Date(year,</span> <span class="pre">month,</span> <span class="pre">day)</span></code> instanziert.)</p>
<p><strong>(4.38 Uhr)</strong>
Tilt! Ich hab endlich verstanden, weshalb die Standardwerte im Insert-Fenster fehlten:
Die kann ich natürlich nicht schon beim Generieren der <code class="xref std std-xfile docutils literal"><span class="pre">site.js</span></code> kennen, also müssen
sie dynamisch bei jedem Insert-Request ermittelt werden.
Konkret: <code class="xref py py-class docutils literal"><span class="pre">lino.ui.extjs.ext_windows.InsertWrapper</span></code> macht jetzt <cite>record_id=-99999</cite>,
und <code class="xref py py-meth docutils literal"><span class="pre">lino.ui.extjs.ext_ui.ExtUI.api_element_view()</span></code> fängt diesen Fall ab und macht dann
ReportRequest.create_instance.</p>
<p>Jetzt fehlt noch das Datum, das ja standardmäßig ja auf heute stehen sollte.
Das ist im Model, in der Felddefinition von <code class="xref py py-attr docutils literal"><span class="pre">Note.date</span></code>.
Ein <cite>auto_now_add=True</cite> ist hier nicht das Richtige, weil das erst in Aktion tritt, wenn das Object gespeichert wird.
Aber <cite>default=datetime.date.today</cite> ist unser Kandidat.</p>
<p>Schön. Jetzt sind alle Standardwerte vorbelegt im Insert-Fenster
(Ausnahme: der Master bei Insert in einem Slave-Fenster. Siehe später.)</p>
<p>Aber vorher haben wir noch ein neues Problem, wenn ich eine neu erstellte notes.Note speichern will:</p>
<div class="highlight-python"><div class="highlight"><pre>ValueError: invalid literal for int() with base 10: &#39;root&#39;
</pre></div>
</div>
<p>Das liegt wahrscheinlich daran, dass username zwar unique ist, aber nicht der primary key ist.
Das hieße, dass man allgemein einen ForeignKey nach <code class="xref py py-class docutils literal"><span class="pre">auth.User</span></code> nicht speichern kann.
Aber <cite>dsbe.Person.user</cite> kann man bearbeiten und speichern. Da funktioniert es.
(Upps: in <cite>Lino.submit_detail</cite> war noch ein kleiner Bug.)</p>
<p>Der Unterschied ist: das PUT beim Speichern einer dsbe.Person sendet korrekterweise:</p>
<blockquote>
<div>user=staff,userHidden=2</div></blockquote>
<p>Aber das POST des submit_insert einer notes.Note sendet:</p>
<blockquote>
<div>user=staff,userHidden=root</div></blockquote>
<p>Wie kommt er darauf, userHidden auf root zu setzen?</p>
<p><cite>GET /choices/contacts/Persons/user</cite> antwortet korrekt:</p>
<blockquote>
<div>{ count: 3, rows: [ { text: &#8220;user&#8221;, value: 1 }, { text: &#8220;staff&#8221;, value: 2 }, { text: &#8220;root&#8221;, value: 3 } ], title: &#8220;Choices for user&#8221; }</div></blockquote>
<p>Und auch <cite>GET /api/notes/NotesByPerson/-99999</cite> oder <cite>GET /api/notes/MyNotes/-99999</cite> antworten korrekt:</p>
<blockquote>
<div>{ navinfo: { msg: &#8220;Row 0 of 2&#8221;, next: null, prev: null, last: 10, first: 1 }, data: { body: &#8220;&#8221;, language: &#8220;Deutsch&#8221;, languageHidden: &#8220;de&#8221;, company: null, typeHidden: null, personHidden: null, companyHidden: null, person: null, url: null, <strong>userHidden: 3, user: &#8220;root&#8221;,</strong> date: new Date(2010,9,1), type: null, id: null, subject: null }, id: null, title: &#8220;(root 2010-10-01)&#8221; }</div></blockquote>
<p>Aber jetzt ist der Fehler von alleine verschwunden oder zumindest nicht mehr reproduzierbar. Also lassen wir das.</p>
<p>Jetzt fehlt vor allem noch der Master bei Insert in einem Slave-Fenster.</p>
<p>Also ich geh z.B. nach <a class="reference external" href="http://127.0.0.1:8000/api/contacts/Persons/79?fmt=detail&amp;tab=4">http://127.0.0.1:8000/api/contacts/Persons/79?fmt=detail&amp;tab=4</a> und klicke aufs Insert der NotesByPerson.
Und das Feld Person ist dann nicht ausgefüllt.
Und das ist logisch, weil der InsertWrapper scheinbar keine base_params hat, denn er schickt ein
<cite>GET api/notes/NotesByPerson/-99999</cite> (es fehlt der Master, <cite>mk=79</cite>).
Genau. Deshalb brauchen wir die neue <code class="xref js js-func docutils literal"><span class="pre">Lino.show_insert_handler()</span></code>.</p>
<p>Fertig! Also die schlimmsten Bugs beim Einfügen sind behoben:</p>
<ul class="simple">
<li>Insert in notes.Note : Datum sollte par défaut auf heute stehen, Sprache auf Deutsch.</li>
<li>Beim Einfügen in einem Slave wird der Master nicht gesetzt.</li>
</ul>
<p>Jetzt zuerst ein <a class="reference external" href="http://code.google.com/p/lino/source/detail?r=540f643cfc3e814438b9c8c2995b154eb01f49b6">Check-In</a> und eine Pause.</p>
<p><strong>(15.30 Uhr)</strong>
Jetzt nehme ich das Problem <a class="reference external" href="https://github.com/lsaffre/lino/blob/master/docs/tickets/5">docs/tickets/5</a> noch mal in die Mangel (SlaveGrid-Elemente zeigen beim ersten Aufruf &#8220;Nix gefunden&#8221;).</p>
<p>Es kommt z.B. wenn ich folgende URL aufrufe:</p>
<blockquote>
<div><a class="reference external" href="http://127.0.0.1:8000/api/contacts/Persons/16?fmt=detail&amp;tab=0">http://127.0.0.1:8000/api/contacts/Persons/16?fmt=detail&amp;tab=0</a></div></blockquote>
<p>Das Bild wird dann nicht angezeigt, und in der Console steht <strong>cmp is rendered but not visible: and now?</strong>.</p>
<p>Wie kann ein <a class="reference external" href="http://www.sencha.com/deploy/dev/docs/?class=Ext.Component">Ext.Component</a> einerseits <cite>rendered</cite> sein und andererseits nicht <cite>visible</cite>?
Okay, wenn er z.B. in einem Tab ist, das momentan versteckt ist.
Ist hier aber nicht der Fall, und außerdem würde der Component dann aufs show-Event reagieren.
Er reagiert auf überhaupt keines der dokumentierten Events.</p>
<p><cite>Ext.Component.isVisible()</cite> ist einfach:</p>
<div class="highlight-python"><div class="highlight"><pre>isVisible : function(){
    return this.rendered &amp;&amp; this.getVisibilityEl().isVisible();
},
</pre></div>
</div>
<p><cite>getVisibilityEl()</cite> ist eine private Funktion:</p>
<div class="highlight-python"><div class="highlight"><pre>getVisibilityEl : function(){
    return this.hideParent ? this.container : this.getActionEl();
},

getActionEl : function(){
    return this[this.actionMode];
},
</pre></div>
</div>
<p>Nee, das bringt alles keine Lösung. Ja, das visibilityEl is offensichtlich noch nicht visible. Aber das ist kein Component mehr und hat also kein render-Event, an das ich mich ran hängen könnte.</p>
<p>Tilt! Idee: ich probiers einfach eine Zehntelsekunde später nochmal:</p>
<div class="highlight-python"><div class="highlight"><pre>Lino.do_when_visible = function(cmp,todo) {
  if (cmp.isVisible()) {
    todo();
  } else {
    if (cmp.rendered) {
      Lino.do_when_visible.defer(100,this,[cmp,todo]);
    } else {
      cmp.on(&#39;afterrender&#39;,todo,cmp,{single:true});
    }
  }
};
</pre></div>
</div>
<p>Das ist zwar eine Frickelslösung, aber es funktioniert! Hurra!</p>
<p>N.B. Anfangs funktionierte es nur fürs Bild, weil für die Slave Grids noch ein anderes Problem war. Preisfrage: Wo ist der Bug in folgendem Code?</p>
<div class="highlight-python"><div class="highlight"><pre>on_master_changed : function() {
  cmp = this;
  var todo = function() {
    var p = cmp.ww.get_master_params();
    for (k in p) cmp.getStore().setBaseParam(k,p[k]);
    cmp.getStore().load();
  };
  Lino.do_when_visible(this,todo);
}
</pre></div>
</div>
<p>Lösung: die zweite Zeile im obigen Code muss natürlich</p>
<div class="highlight-python"><div class="highlight"><pre>var cmp = this;
</pre></div>
</div>
<p>sein. Ich alter Python-Programmierer habe eine knappe Stunde gebraucht, um das fehlende <code class="docutils literal"><span class="pre">var</span></code> zu finden.
Ohne das <code class="docutils literal"><span class="pre">var</span></code> ist <code class="docutils literal"><span class="pre">cmp</span></code>  eine globale Variable,
und dann ruft er <cite>Lino.do_when_visible</cite> zwar brav auf jeder Grid, aber wenn die sichtbar wird, wird die <code class="docutils literal"><span class="pre">todo</span></code> immer nur auf der letzten Grid (NotesByPerson) aufgerufen.</p>
<p>Ich selber habs jetzt übrigens mit <cite>createDelegate</cite> statt einem <cite>this</cite>-Ersatz gemacht,
weil ich das eleganter finde:</p>
<div class="highlight-python"><div class="highlight"><pre>on_master_changed : function() {
  var todo = function() {
    var p = this.ww.get_master_params();
    for (k in p) this.getStore().setBaseParam(k,p[k]);
    this.getStore().load();
  };
  Lino.do_when_visible(this,todo.createDelegate(this));
}
</pre></div>
</div>
<p>Fazit: Ich verstehe weiterhin nicht, wie ein Component im beschriebenen Fall rendered und trotzdem nicht visible sein kann,
ich kriegs auch nicht reproduziert in einem einfachen showcase,
aber jetzt habe ich immerhin eine funktionierende Lösung, die bis auf weiteres vollkommen reicht.
Also Problem <a class="reference external" href="https://github.com/lsaffre/lino/blob/master/docs/tickets/5">docs/tickets/5</a> ist für mich abgeschlossen.</p>
<p><a class="reference external" href="http://code.google.com/p/lino/source/detail?r=d3e1a52c1d87c2fdbb0485d146001bb38aa57eeb">Check-In</a> und Wochenende.</p>
<p><strong>(22 Uhr)</strong> Vor dem Schlafengehen noch schnell einen Punkt aus der <a class="reference external" href="http://www.lino-framework.org/todo.html">/todo</a> abgearbeitet:</p>
<ul class="simple">
<li>Neue Tabelle &#8220;Ansprechpartner pro Person&#8221; mit einem Feld &#8220;Rolle&#8221; oder &#8220;Eigenschaft&#8221;,
dessen Auswahlliste konfigurierbar ist
(&#8216;Hauptkontakt&#8217;, &#8216;DSBE&#8217;, &#8216;allgemeiner Sozialdienst&#8217;, &#8216;Schulderberatung&#8217;, &#8216;Energieberatung&#8217;).
Das Feld <cite>Person.user</cite> kann dann raus, und <cite>PAR-&gt;IdUsr</cite> muss in diese Tabelle importiert werden.
Im Layout2 (&#8220;Person&#8221;) muss dann <code class="docutils literal"><span class="pre">user</span></code> ersetzt werden durch eine Tabelle von Ansprechpartnern.
Konkret also vor allem 2 neue Tabellen:<ul>
<li>CoachType : (id,name)</li>
<li>Coach : (user,type,person,company)</li>
</ul>
</li>
</ul>
<p>Eine Vereinfachung: das Feld <cite>Person.user</cite> (Hauptansprechpartner) bleibt dennoch drin. Vor allem weil es sonst kompliziert und untransparent wäre, diese eine Zeile bei importierten Personen schreibgeschützt zu machen.</p>
<p>Interessant ist zu bemerken, dass die ganze Aktion nur 45 Minuten gedauert hat, inklusive fixtures und Reorganisierung der Eingabebildschirme (aber ohne Blogschreiben).</p>
<p>Wobei die letzten 15 Minuten eigentlich nicht zählen, denn die habe ich gebraucht um rauszufinden, dass einige Layout-Bugs doch noch dringend behoben werden sollten. Im Moment sind die meisten Bugs sichtbar im Detail von dsbe.Persons. Da kriege ich Montag noch was zu tun:</p>
<ul class="simple">
<li>Im Tab &#8220;Kontakt&#8221; fehlen die flags, die ich noch zwischen remarks und coaching knallen will. Zumindest will ich mal sehen, wie sich das macht. Aber wenn ich das tue, ist die ganze untere hbox nicht mehr da.</li>
<li>Im Tab &#8220;Kontakt&#8221;, box &#8220;coaching&#8221; nimmt die Grid zu viel Platz ein. Da hat Lino unnötigerweise einen VBorderPanel benutzt. Das ist nicht nötig, wenn nur ein Element vflex ist.</li>
<li>Im Tab &#8220;Person&#8221; nimmt die Grid zu viel Höhe.</li>
<li>Im Detail-Tab &#8220;Profil 1&#8221; nimmt das GridElement anfangs den ganzen Raum ein, die Felder im oberen Teil werden erst nach einem resize sichtbar.</li>
<li>Wieso lässt &#8220;Studien &amp; Erfahrungen&#8221; im Tab &#8220;Person&#8221; sich höhenverstellen, aber &#8220;AG-Sperren&#8221; in &#8220;Profil 1&#8221; nicht?</li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="1004.html" title="20101004"
             >next</a> |</li>
        <li class="right" >
          <a href="0930.html" title="20100930 disabled fields"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2010</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2010/1001.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2010/1001.html">Online Link</a>
    </div>
  </body>
</html>