<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20100706 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2010" href="index.html" />
    <link rel="next" title="20100707" href="0707.html" />
    <link rel="prev" title="20100705 Zurück zu Sphinx" href="0705.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0707.html" title="20100707"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0705.html" title="20100705 Zurück zu Sphinx"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2010</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20100706<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>So, heute sind die Print-Aktionen (<code class="xref py py-class docutils literal"><span class="pre">lino.utils.mixins.PrintMethod</span></code>) in <a class="reference external" href="http://www.lino-framework.org/ref/obsolete.html#module-lino.ui.extjsu" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.ui.extjsu</span></code></a> dran.
Die funktionieren jetzt. Vorher musste ich einige Dinge verstehen:</p>
<ul class="simple">
<li>Aktionen sind ja nur passive Klassen, die eine Aktion &#8220;äußerlich&#8221; beschreiben. Was z.B. GridEdit oder DeleteSelcted (oder demnächst PrintUsingAppy) genau tun, das hängt vom User Interface ab. Mit &#8220;äußerlich&#8221; meine ich: Name, Label, Erlaubtheit, Reihenfolge...</li>
<li><code class="xref py py-meth docutils literal"><span class="pre">lino.modlib.notes.NoteType.template_type()</span></code> braucht eine globale Liste der PrintMethods, die auf dem Server zur Verfügung stehen (pisa, rtf, appy, latex,...).</li>
<li>PrintMethods können keine Aktionen werden.</li>
<li>Sehr zufrieden bin ich noch nicht mit dem Aktionen-System. Notiert in <a class="reference external" href="http://www.lino-framework.org/todo.html">/todo</a>.</li>
</ul>
<p>Um das Drucken zu testen, muss ich allerdings Notizarten definieren. Und da kommt das Problem, dass die kein Detail haben und deshalb aus der Grid raus erstellt werden müssen. Und das funktioniert noch nicht im extjsu. Ran an den Speck... da kam vor allem ein IntegrityError auf dem Server. Okay, also in Django darf man nicht einfach <cite>Model.save()</cite> machen, sondern muss die Instanz zuerst validieren:
<a class="reference external" href="http://docs.djangoproject.com/en/dev/ref/models/instances/#id1">http://docs.djangoproject.com/en/dev/ref/models/instances/#id1</a></p>
<p>Aber ich kann noch immer keine Notizart erstellen,
weil ich kein <code class="xref py py-attr docutils literal"><span class="pre">lino.modlib.notes.models.NoteType.template</span></code>
auswählen kann. Das liegt daran, dass die choosers noch nicht
verknüpft sind. Der nächste Punkt aus der <a class="reference external" href="http://www.lino-framework.org/todo.html">/todo</a>.</p>
<p>Die Response auf <a class="reference external" href="http://127.0.0.1:8000/api/notes/NoteTypes?fmt=grid">http://127.0.0.1:8000/api/notes/NoteTypes?fmt=grid</a> ruft ja lediglich <a class="reference external" href="http://www.lino-framework.org/ref/javascript.html#Lino.notes.NoteTypes.grid" title="(in Lino v1.6)"><code class="xref js js-func docutils literal"><span class="pre">Lino.notes.NoteTypes.grid()</span></code></a>, die in der <code class="file docutils literal"><span class="pre">site.js</span></code> definiert ist:</p>
<div class="highlight-python"><div class="highlight"><pre>Lino.notes.NoteTypes.grid = function(params) {
  var NoteType_id_field = { fieldLabel: &quot;ID&quot;, xtype: &quot;numberfield&quot;, name: &quot;id&quot; };
  var NoteType_name_field = new Ext.form.TextField({ ... });
  var NoteType_print_method_field = new Lino.ChoicesFieldElement({ ... });
  var NoteType_template_field = new Lino.RemoteComboFieldElement({ ... });
  var main_grid = new Lino.GridPanel({ ls_store_fields: [ ... ],
    before_row_edit: function(record){
      NoteType_template_field.setContextValue(&#39;print_method&#39;,record.data[&#39;print_methodHidden&#39;]);
    },
    xtype: &quot;container&quot;, ls_content_type: 23, ls_data_url: &quot;/api/notes/NoteTypes&quot;,
      colModel: new Ext.grid.ColumnModel({ columns: [
        ...,
        new Ext.grid.Column({ ... dataIndex: &quot;template&quot;, editor: NoteType_template_field })
      ] }),
    ... },params);
  return main_grid
}
</pre></div>
</div>
<p>Was hier noch fehlt, ist der Handler fürs <code class="docutils literal"><span class="pre">change</span></code>-Event von <cite>NoteType_print_method_field</cite>. Deshalb nun ein neuer Konfigurationsparameter <cite>setup_events</cite> für Lino.GridPanel.</p>
<p>Das funktioniert, nun kann ich alle Felder im Grid ausfüllen. Aber da kommt das nächste Problem:</p>
<div class="highlight-python"><div class="highlight"><pre>Traceback (most recent call last):
  ...
  File &quot;t:\hgwork\lino\lino\ui\extjsu\ext_ui.py&quot;, line 458, in api_list_view
    instance.save(force_insert=True)
  ...
IntegrityError: PRIMARY KEY must be unique
[06/Jul/2010 14:33:46] &quot;POST /api/notes/NoteTypes HTTP/1.1&quot; 500 2049
</pre></div>
</div>
<p>Das kommt daher, dass mein POST den pk des neuen Records auf -99999 setzt.
Logisch, dass <code class="xref py py-meth docutils literal"><span class="pre">Model.full_clean()</span></code> da nichts zu meckern findet.
Ich finde es ja nicht korrekt von Django, dass man IntegrityError nicht abfangen darf.
Aber okay, in diesem Beispiel haben sie Recht: wenn der Benutzer das als Meldung bekäme, könnte er sowieso nichts damit anfangen.</p>
<p>Die Sache mit dem Pseudowert -99999 ist ja unschön.
Die hatte ich angefangen, weil ExtJS auch für leere Records eine id haben will.
Wenn ich keine id angebe, dann füllt er selber einen Wert im Stil <code class="docutils literal"><span class="pre">'ext-record-6</span></code> ein (&#8220;If an id is not specified a phantom Record will be created with an automatically generated id.&#8221;, <a class="reference external" href="http://www.sencha.com/deploy/dev/docs/source/Record.html#cls-Ext.data.Record">ExtJS Doku</a>),
und dann macht der Server beim PUT einen
<code class="docutils literal"><span class="pre">ValueError:</span> <span class="pre">invalid</span> <span class="pre">literal</span> <span class="pre">for</span> <span class="pre">int()</span> <span class="pre">with</span> <span class="pre">base</span> <span class="pre">10:</span> <span class="pre">'ext-record-6'</span></code>.
Mein -99999 würde aber gar nicht funktionieren im Fall von mehr als einem Extra-Records.
Also muss ich mir da sowieso was Besseres einfallen lassen.
Die Lösung ist: ich muss <cite>Ext.data.Record.phantom</cite> abfragen.
<code class="xref js js-func docutils literal"><span class="pre">Lino.grid_afteredit_handler()</span></code> tut das jetzt.</p>
<p>Aber da ist noch ein Problem: <code class="xref js js-func docutils literal"><span class="pre">Lino.grid_afteredit_handler()</span></code> schickt mindestens seit heute und vielleicht schon seit Längerem die Werte der ComboBoxen nicht richtig ab. Das war ja sowieso sehr holperig gemacht. Danach muss ich morgen schauen, jetzt ist erst mal Feierabend...</p>
<p>Check-In 1061:f8b8943bec84</p>
<p>(Ich konnte mich natürlich nicht zurückhalten, zwischendurch auch immer mit Sphinx zu spielen:
<a class="reference external" href="https://github.com/lsaffre/lino/blob/master/docs/tickets/4">docs/tickets/4</a> und
<a class="reference external" href="http://www.lino-framework.org/tests.html">/tests</a>)</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0707.html" title="20100707"
             >next</a> |</li>
        <li class="right" >
          <a href="0705.html" title="20100705 Zurück zu Sphinx"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2010</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2015 Luc Saffre.
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
    <a href="https://raw.github.com/lsaffre/blog/master/docs/blog/2010/0706.rst"
           rel="nofollow">Show Source</a>.
    <a href="http://luc.lino-framework.org/blog/2010/0706.html">Online Link</a>
    </div>
  </body>
</html>