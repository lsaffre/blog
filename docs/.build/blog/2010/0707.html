<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20100707 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2010" href="index.html" />
    <link rel="next" title="20100708" href="0708.html" />
    <link rel="prev" title="20100706" href="0706.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0708.html" title="20100708"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0706.html" title="20100706"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2010</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20100707<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>Also wie gestern festgestellt, schickt <code class="xref js js-func docutils literal"><span class="pre">Lino.grid_afteredit_handler()</span></code> die Werte der ComboBoxen nicht richtig ab.</p>
<p>Auch stelle ich mir die Frage, ob es nicht besser ist, erst beim Verlassen des Records abzuschicken.</p>
<p>Fallbeispiel: ich gehe nach <a class="reference external" href="http://127.0.0.1:8000/api/notes/NoteTypes?fmt=grid">http://127.0.0.1:8000/api/notes/NoteTypes?fmt=grid</a> und fülle
dort die drei Felder einer neuen Notizart aus:</p>
<a class="reference internal image-reference" href="../../_images/20100707.jpg"><img alt="../../_images/20100707.jpg" src="../../_images/20100707.jpg" style="width: 417.0px; height: 174.6px;" /></a>
<p>Nach jedem Feld schickt er ein POST ab, das der Server bei den ersten beiden Feldern
korrekterweise mit einer Fehlermeldung
beantwortet, weil die Felder print_method und template nicht ausgefüllt sind.</p>
<p>Beim dritten Mal müsste er eigentlich speichern... tut er aber nicht.
Und zwar, weil mit den Werten der ComboBoxen etwas nicht stimmt.
Hier die Werte, die er beim dritten POST abschickt:</p>
<table border="1" class="docutils">
<colgroup>
<col width="68%" />
<col width="32%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>id</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>name</td>
<td>test</td>
</tr>
<tr class="row-odd"><td>print_method</td>
<td>appy</td>
</tr>
<tr class="row-even"><td>print_methodHidden</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>template</td>
<td>phone.odt</td>
</tr>
</tbody>
</table>
<p>Das ist nicht normal.
(1) Wieso gibt es kein <cite>templateHidden</cite>?
Und (2) wieso ist <cite>print_methodHidden</cite> leer?
Und (3) wieso wird im Feld <cite>print_method</cite> &#8220;appy&#8221; (also die value) angezeigt, nachdem ich doch &#8220;AppyPrintMethod&#8221; (den text) ausgewählt habe?
Drei Probleme auf einmal!</p>
<p>print_method und template sind in der site.js wie folgt definiert:</p>
<div class="highlight-python"><div class="highlight"><pre>var NoteType_print_method_field = new Lino.ChoicesFieldElement({
    allowBlank: false, fieldLabel: &quot;print method&quot;, name: &quot;print_method&quot;,
    store: [ [ &quot;pisa&quot;, &quot;PisaPrintMethod&quot; ], [ &quot;appy&quot;, &quot;AppyPrintMethod&quot; ],
        [ &quot;rtf&quot;, &quot;RtfPrintMethod&quot; ], [ &quot;picture&quot;, &quot;PicturePrintMethod&quot; ] ],
    hiddenName: &quot;print_methodHidden&quot; });
var NoteType_template_field = new Lino.RemoteComboFieldElement({
    allowBlank: false, fieldLabel: &quot;template&quot;, name: &quot;template&quot;,
    store: new Lino.RemoteComboStore({ proxy: new Ext.data.HttpProxy({
        url: &quot;/choices/notes/NoteTypes/template&quot;, method: &quot;GET&quot; }) }),
    hiddenName: &quot;templateHidden&quot; });
</pre></div>
</div>
<p>Das sieht richtig aus, und die restlichen Parameter der ComboBoxen sind
ja in der <code class="file docutils literal"><span class="pre">lino.js</span></code> definiert:</p>
<div class="highlight-python"><div class="highlight"><pre>Lino.ComboBox = Ext.extend(Ext.form.ComboBox,{
  triggerAction: &#39;all&#39;,
  submitValue: true,
  displayField: &#39;text&#39;, // ext_requests.CHOICES_TEXT_FIELD
  valueField: &#39;value&#39; // ext_requests.CHOICES_VALUE_FIELD
});

Lino.ChoicesFieldElement = Ext.extend(Lino.ComboBox,{
  mode: &#39;local&#39;,
  forceSelection: false
});

Lino.RemoteComboStore = Ext.extend(Ext.data.JsonStore,{
  constructor: function(config){
      Lino.RemoteComboStore.superclass.constructor.call(this, Ext.apply(config, {
          totalProperty: &#39;count&#39;,
          root: &#39;rows&#39;,
          id: &#39;value&#39;, // ext_requests.CHOICES_VALUE_FIELD
          fields: [&#39;value&#39;,&#39;text&#39;], // ext_requests.CHOICES_VALUE_FIELD, // ext_requests.CHOICES_TEXT_FIELD
          listeners: { exception: Lino.on_store_exception }
      }));
  }
});

Lino.RemoteComboFieldElement = Ext.extend(Lino.ComboBox,{
  mode: &#39;remote&#39;,
  minChars: 2, // default 4 is to much
  queryDelay: 300, // default 500 is maybe slow
  queryParam: &#39;query&#39;, // ext_requests.URL_PARAM_FILTER)
  typeAhead: true,
  selectOnFocus: true, // select any existing text in the field immediately on focus.
  resizable: true
});
</pre></div>
</div>
<p>Upps: <cite>displayField</cite> und <cite>valueField</cite> darf ich nur für Lino.RemoteComboFieldElement (nicht für Lino.ChoicesFieldElement) setzen, denn (Auszüge aus der ExtJS-Dokumetantion):</p>
<ul class="simple">
<li>valueField  : The underlying data value name to bind to this ComboBox (defaults to [...] &#8216;field2&#8217; if [...] the field name is autogenerated based on the store configuration).</li>
<li>For a multi-dimensional array, the value in index 0 of each item will be assumed to be the combo valueField, while the value at index 1 is assumed to be the combo displayField.</li>
</ul>
<p>Aber das löst keine der drei Probleme...</p>
<p>Auch die (dynamische) Auswahlliste für <cite>template</cite> wird mit
<a class="reference external" href="http://127.0.0.1:8000/choices/notes/NoteTypes/template?print_method=appy">http://127.0.0.1:8000/choices/notes/NoteTypes/template?print_method=appy</a>
korrekt angefragt, und auch die Antwort des Servers darauf ist korrekt:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span> <span class="n">count</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="n">rows</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="n">text</span><span class="p">:</span> <span class="s">&quot;contacts.Person.odt&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">&quot;contacts.Person.odt&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">text</span><span class="p">:</span> <span class="s">&quot;phone.odt&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">&quot;phone.odt&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">text</span><span class="p">:</span> <span class="s">&quot;test</span><span class="se">\\</span><span class="s">phone.odt&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="s">&quot;test</span><span class="se">\\</span><span class="s">phone.odt&quot;</span> <span class="p">}</span>
  <span class="p">],</span>
  <span class="n">title</span><span class="p">:</span> <span class="s">&quot;Choices for template&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Liegt es etwa daran, dass <cite>Lino.GridPanel</cite> mein <cite>ComboBox.setValue()</cite>
ohne den zweiten Parameter <cite>record</cite> aufruft? Nein, das funktioniert.</p>
<p>Am Ende von meiner <code class="xref py py-func docutils literal"><span class="pre">ComboBox.setValue()</span></code> war ein <code class="docutils literal"><span class="pre">this.value</span> <span class="pre">=</span> <span class="pre">v;</span></code>.
Wenn ich es rauskommentiere, ist immerhin Problem (3) gelöst.</p>
<p>Aber es sieht aus als ob das hiddenField einer ComboBox nie in den Record gespeichert wird.
Kann es sein, dass dieser Mechanismus nur im Falle einer Form funktioniert?
Ja, sieht aus als das ein wichtiger Unterschied zwischen Form und Grid ist: Forms arbeiten ohne Record.
Auch ein <a class="reference external" href="http://www.sencha.com/deploy/dev/examples/grid/row-editor.html">RowEditor-Grid</a> ändert
da nichts dran.</p>
<p><code class="docutils literal"><span class="pre">EditorGridPanel.onEditComplete(ed,</span> <span class="pre">value,</span> <span class="pre">startValue)</span></code> schickt die <cite>value</cite> zunächst
durch <code class="docutils literal"><span class="pre">this.postEditValue(value,</span> <span class="pre">startValue,</span> <span class="pre">r,</span> <span class="pre">field)</span></code> und dann
durchs validateedit-Event, und ruft dann
Record.set(field, e.value);</p>
<p>Tilt: im columnModel muss der dataIndex von ComboBoxen aufs Hidden-Field zeigen!</p>
<p>Dann macht auch endlich die Bemerkung &#8220;If using a ComboBox in an Editor Grid a renderer will be needed to show the displayField when the editor is not active.&#8221; aus der ExtJS-Doku Sinn!</p>
<p>Diese Änderung wird vielleicht noch Nebenwirkungen haben, aber das ist die richtige Richtung.</p>
<p>Der besagte Renderer für die GridColumns war nicht schwer und ist auch nicht sehr teuer:</p>
<div class="highlight-python"><div class="highlight"><pre>Lino.comboRenderer = function(displayField){
    return function(value,metadata,record,ri,ci,store){
        if (record) return record.get(displayField)
        return &#39;&#39;;
    }
}
</pre></div>
</div>
<p>Dieser Renderer verlässt sich darauf, dass der von Lino erzeugte Record für alle Combobox-Felder immer zwei Felder hat: <cite>value</cite> und <cite>text</cite>.</p>
<p>Jetzt habe ich noch das Problem, dass <code class="xref py py-meth docutils literal"><span class="pre">ComboStoreField.get_value_text()</span></code> für <code class="xref py py-attr docutils literal"><span class="pre">NoteType.template</span></code> noch nicht funktioniert. Das ist nämlich non-FK field mit chooser. Dass dieser Fall nicht funktionierte, war bisher noch nicht aufgefallen.</p>
<p>Übrigens ist <code class="xref py py-attr docutils literal"><span class="pre">NoteType.template</span></code> außerdem ein Feld mit eindimensionaler Auswahlliste, also keine &#8220;value,text&#8221;-Paare, sondern lediglich eine Liste von Dateienamen, die auch als solche angezeigt werden.</p>
<p>Also jedenfalls darf es nicht so sein, dass der Server pro <cite>NoteType`jedesmal deren `template_choices</cite> aufruft, nur um festzustellen, dass das ein eindimensionales Array ist und die Liste deshalb gar nicht nötig war.</p>
<p>Diese Details müssen jetzt wohl bis morgen warten, denn es ist seit langem Feierabend...</p>
<p>(Fortsetzung folgt <a class="reference internal" href="0708.html"><em>morgen</em></a>)</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0708.html" title="20100708"
             >next</a> |</li>
        <li class="right" >
          <a href="0706.html" title="20100706"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2010</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2010/0707.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2010/0707.html">Online Link</a>
    </div>
  </body>
</html>