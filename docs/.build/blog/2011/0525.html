<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20110525 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2011" href="index.html" />
    <link rel="next" title="20110526" href="0526.html" />
    <link rel="prev" title="20110524" href="0524.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0526.html" title="20110526"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0524.html" title="20110524"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2011</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20110525<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="datenkonvertierung">
<h2>Datenkonvertierung<a class="headerlink" href="#datenkonvertierung" title="Permalink to this headline">¶</a></h2>
<p>Alle bestehenden Inhalte in <cite>Note.body</cite>, die ja bisher im rst-Format
eingegeben waren, müssen jetzt HTML-formatiert in der Datenbank stehen.
Weil diese Konvertierung nicht einfach rückgängig gemacht werden kann,
mach ich das vorerst mal nur auf meinem Rechner und teste die Sache
intern.</p>
<p>Also einmal beim Kunden eine Kopie der Datenbank holen:</p>
<div class="highlight-python"><div class="highlight"><pre>cd /usr/local/django/myproject
./dump
cp fixtures/d20110525.dpy media/webdav
</pre></div>
</div>
<p>Dann die Datei <code class="file docutils literal"><span class="pre">d20110525.dpy</span></code> von beim Kunden in mein
lokales fixtures-Verzeichnis runterladen folgende kleine
manuelle Änderung machen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">lino.utils.restify</span> <span class="kn">import</span> <span class="n">restify</span> <span class="c"># neue Zeile</span>
<span class="k">def</span> <span class="nf">create_notes_note</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">user_id</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="o">...</span><span class="p">):</span>
    <span class="c"># vorher return Note(id=id,user_id=user_id,...,body=body,...)</span>
    <span class="k">return</span> <span class="n">Note</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span><span class="o">...</span><span class="p">,</span><span class="n">body</span><span class="o">=</span><span class="n">restify</span><span class="p">(</span><span class="n">body</span><span class="p">),</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Dann mit folgendem Befehl bei mir importieren:</p>
<div class="highlight-python"><div class="highlight"><pre>python manage.py initdb d20110525
</pre></div>
</div>
<p>Ist das nicht wunderbar einfach? Bin noch immer wieder begeistert
darüber, wie gut mein System zur <a class="reference external" href="http://www.lino-framework.org/admin/datamig.html">/admin/datamig</a> funktioniert.</p>
<p>Upps, beim ersten Aufruf kommt nun ein Fehler, der wahrscheinlich auch schon
vor dem Datenimport gekommen wäre, weil er auf meine Änderung von gestern
zurückzuführen ist:</p>
<div class="highlight-python"><div class="highlight"><pre>  File &quot;t:\hgwork\lino\lino\ui\extjs3\urls.py&quot;, line 34, in &lt;module&gt;
    settings.LINO.setup()
  File &quot;t:\hgwork\lino\lino\apps\std\settings.py&quot;, line 152, in setup
    setup_site(self)
  File &quot;t:\hgwork\lino\lino\core\kernel.py&quot;, line 213, in setup_site
    analyze_models(self)
  File &quot;t:\hgwork\lino\lino\core\kernel.py&quot;, line 107, in analyze_models
    model.site_setup(self)
  File &quot;t:\hgwork\lino\lino\apps\dsbe\models.py&quot;, line 693, in site_setup
    bank_account1 bank_account2 activity&#39;&#39;&#39;)
  File &quot;t:\hgwork\lino\lino\reports.py&quot;, line 87, in fields_list
    return tuple([get_field(model,n) for n in field_names.split()])
  File &quot;t:\hgwork\lino\lino\tools.py&quot;, line 61, in get_field
    raise Exception(&quot;get_field(%r,%r) got a remote model ?!&quot; % (model,name))
Exception: get_field(&lt;class &#39;lino.apps.dsbe.models.CourseProvider&#39;&gt;,&#39;name&#39;) got a remote model ?!
</pre></div>
</div>
<p>Ja, also <code class="xref py py-class docutils literal"><span class="pre">CourseProvider</span></code> ist ja ein MTI-Child von <code class="xref py py-class docutils literal"><span class="pre">Company</span></code>,
und wenn ein Report sich <code class="xref py py-attr docutils literal"><span class="pre">CourseProvider.name</span></code> anfragt, ist das Feld
ja nicht in <code class="xref py py-class docutils literal"><span class="pre">CourseProvider</span></code> sondern <code class="xref py py-class docutils literal"><span class="pre">Company</span></code> definiert.
Ich hole diese <cite>assert</cite> aus <code class="xref py py-func docutils literal"><span class="pre">lino.tools.get_field()</span></code> einfach raus,
die war da sowieso eher spontan eingefügt.</p>
<p>Die Konvertierung von reST nach HTML scheint insgesamt
gut geklappt zu haben,
aber beim Testen sehe ich noch mehrere kleinere Bugs,
die ich wohl beheben muss vor dem Release:</p>
<ul class="simple">
<li>Notiz #91 wird nicht korrekt ausgedruckt (der letzte Teil
ab dem Titel &#8220;Vorschlag&#8221; wird weder gedruckt noch schreibt appy.opd eine
Fehlermeldung ins ODT-Dokument.</li>
<li>Auch Notiz #90 nicht. Da verschwindet nur der Titel...</li>
<li>Bei längeren Texten ist ein Problem mit der Größe des Editors.
Die letzten Zeilen kann man selbst mit Hilfe des Scrollbars nicht anzeigen.
Könnte ein Bug in TinyMCE sein, oder in Ext.ux.TinyMCE.
Praktischer Workarund wäre ein Button &#8220;Open in own Window&#8221; für das Editor-Panel.</li>
</ul>
</div>
<div class="section" id="ein-neuer-testfall-fur-appy-pod">
<h2>Ein neuer Testfall für appy.pod<a class="headerlink" href="#ein-neuer-testfall-fur-appy-pod" title="Permalink to this headline">¶</a></h2>
<p>Oh je! Es ist gar nicht so leicht, die oben erwähnten Fehler in reproduzierbare
Testcases zu packen!</p>
<p>Der Testcase 8 (in <a class="reference external" href="https://github.com/lsaffre/lino/blob/master//tests/appy/1/test.py">/tests/appy/1/test.py</a>) produzierte folgenden
Traceback:</p>
<div class="highlight-python"><div class="highlight"><pre>Error while evaluating the expression &quot;html(HTML)&quot; defined in the &quot;from&quot; part of a statement.
File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
File &quot;t:\hgwork\lino\lino\utils\appy_pod.py&quot;, line 66, in html_func
return renderer.renderXhtml(html,**kw)
File &quot;l:\snapshots\appy-0.6.6\appy\pod\renderer.py&quot;, line 242, in renderXhtml
stylesMapping, ns).run()
File &quot;l:\snapshots\appy-0.6.6\appy\pod\xhtml2odt.py&quot;, line 502, in run
self.xhtmlParser.parse(self.xhtmlString)
File &quot;l:\snapshots\appy-0.6.6\appy\shared\xml_parser.py&quot;, line 193, in parse
self.parser.parse(inputSource)
File &quot;c:\Python27\lib\xml\sax\expatreader.py&quot;, line 107, in parse
xmlreader.IncrementalParser.parse(self, source)
File &quot;c:\Python27\lib\xml\sax\xmlreader.py&quot;, line 123, in parse
self.feed(buffer)
File &quot;c:\Python27\lib\xml\sax\expatreader.py&quot;, line 211, in feed
self._err_handler.fatalError(exc)
File &quot;c:\Python27\lib\xml\sax\handler.py&quot;, line 38, in fatalError
raise exception
&lt;class &#39;xml.sax._exceptions.SAXParseException&#39;&gt;: &lt;unknown&gt;:2:33: not well-formed (invalid token)
</pre></div>
</div>
<p>Um zu sehen, worauf sich die 2:33 bezieht, brauchte ich wieder die zwei Zeilen in der
<code class="xref py py-func docutils literal"><span class="pre">appy.pod.renderer.Renderer.renderXhtml()</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>xhtmlContent = &#39;&lt;p&gt;%s&lt;/p&gt;&#39; % xhtmlString
import codecs
codecs.open(&#39;20110523.log&#39;,&#39;w&#39;,encoding=encoding).write(xhtmlContent)
return Xhtml2OdtConverter(xhtmlContent, encoding, self.stylesManager,
</pre></div>
</div>
<p>Das besagte XHTML-Fragment lautet:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;p&gt;
&lt;p&gt;&lt;span class=&quot;Apple-style-span&quot;, style=&quot;font-size: 13px; line-height: 19px; font-family: sans-serif;&quot;&gt;Lorem ipsum dolor sit amet, consectetur adipisici elit, sed eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquid ex ea commodi consequat. Quis aute iure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.&lt;/span&gt;&lt;/p&gt;
</pre></div>
</div>
<p>Aha, der Fehler ist das Komma. Das war ein Bug in meiner Funktion <cite>html2xhtml</cite>.
Der trat also nur auf, wenn ein <em>tag</em> mehr als ein <em>attributes</em> hatte.
Und weil der Bug so einfach war, habe ich knapp 2 Stunden danach gesucht...</p>
</div>
<div class="section" id="eintauchen-in-die-docutils">
<h2>Eintauchen in die <cite>docutils</cite><a class="headerlink" href="#eintauchen-in-die-docutils" title="Permalink to this headline">¶</a></h2>
<p>Die Bugs beim Ausdruck der Notizen 91 und 92 kamen daher, dass ich bei meinem
ersten Datenimport die <code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;document&quot;&gt;</span></code> (die par défaut von <cite>html_body</cite>
generiert wird) nicht entfernt hatte.
Das ist ja ein <a class="reference external" href="https://bugs.launchpad.net/appy/+bug/777890">Bug in appy.pod</a>,
den ich umgehen kann.</p>
<p>Deshalb wird das jetzt nicht mehr in <code class="xref py py-func docutils literal"><span class="pre">lino.utils.appy_pod.setup_renderer()</span></code>,
sondern in <a class="reference external" href="http://www.lino-framework.org/api/lino.utils.restify.html#lino.utils.restify.restify" title="(in Lino v1.6)"><code class="xref py py-func docutils literal"><span class="pre">lino.utils.restify.restify()</span></code></a> gemacht.</p>
<p>Aber upps, beim Datenimport muss ich feststellen,
dass <cite>html_body</cite> im <em>surrounding DIV tag</em>
manchmal auch ein Attribut <cite>id</cite> hinzufügt:
<code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;document&quot;</span> <span class="pre">id=&quot;markup-beispiele&quot;&gt;</span></code>.
Genauer gesagt immer dann, wenn das reST-Text einen Haupttitel hat.
Und dann funktioniert mein uneleganter Workaround in der
<a class="reference external" href="http://www.lino-framework.org/api/lino.utils.restify.html#lino.utils.restify.restify" title="(in Lino v1.6)"><code class="xref py py-func docutils literal"><span class="pre">lino.utils.restify.restify()</span></code></a> nicht...</p>
<p>Zum Glück hatte Günter Milde (schon) vor 2 Wochen auf meine Frage im
Docutils-Forum <a class="reference external" href="http://sourceforge.net/mailarchive/message.php?msg_id=27467363">geantwortet</a>,
so dass ich die Sache nun &#8220;richtig&#8221; lösen konnte.
Also in <a class="reference external" href="http://www.lino-framework.org/api/lino.utils.restify.html#module-lino.utils.restify" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.utils.restify</span></code></a> überschreibe ich den <cite>HtmlTranslator</cite>
von docutils so dass er dieses DIV-tag gar nicht erst einfügt.</p>
<p>Voilà, das war&#8217;s. Die Notizen #91 und #92 funktionieren jetzt.</p>
</div>
<div class="section" id="fur-morgen">
<h2>Für morgen<a class="headerlink" href="#fur-morgen" title="Permalink to this headline">¶</a></h2>
<p>Jetzt bleiben für morgen also &#8220;nur&#8221; noch die &#8220;äußeren&#8221; Probleme:</p>
<ul class="simple">
<li>Der Editor wird nicht schreibgeschützt, wenn die Notiz ausgedruckt wurde.
<cite>Ext.ux.TinyMCE</cite> ignoriert offenbar die Option <cite>disabled</cite>.</li>
<li>Mindestens eines der Sonderzeichen &#8220;Ω&#8221;, &#8220;Φ&#8221; oder &#8220;→&#8221; führt
beim Ausdrucksversuch zur Fehlermeldung
<code class="docutils literal"><span class="pre">'charmap'</span> <span class="pre">codec</span> <span class="pre">can't</span> <span class="pre">encode</span> <span class="pre">character</span> <span class="pre">u'\u03a9'</span> <span class="pre">in</span> <span class="pre">position</span> <span class="pre">278:</span>
<span class="pre">character</span> <span class="pre">maps</span> <span class="pre">to</span> <span class="pre">&lt;undefined&gt;</span></code>.</li>
<li>Bei längeren Texten ist ein Problem mit der Größe des Editors.
Die letzten Zeilen kann man selbst mit Hilfe des Scrollbars nicht anzeigen.
Könnte ein Bug in TinyMCE sein, oder in Ext.ux.TinyMCE.
Praktischer Workarund wäre ein Button &#8220;Open in own Window&#8221; für das Editor-Panel.</li>
<li>Zentrierte Absätze werden nicht zentriert gedruckt.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0526.html" title="20110526"
             >next</a> |</li>
        <li class="right" >
          <a href="0524.html" title="20110524"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2011</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2011/0525.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2011/0525.html">Online Link</a>
    </div>
  </body>
</html>