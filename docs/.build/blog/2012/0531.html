<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20120531 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2012" href="index.html" />
    <link rel="next" title="20120601" href="0601.html" />
    <link rel="prev" title="20120530" href="0530.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0601.html" title="20120601"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0530.html" title="20120530"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2012</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20120531<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p><code class="xref py py-mod docutils literal"><span class="pre">lino.modlib.cbss.fixtures.inscodes</span></code> didn&#8217;t work on existing data
that had no French country names.
Now it is based on a dictionary ISO code to the corresponding
code of the Belgian &#8220;Institut National de Statistique&#8221;.</p>
<p><code class="xref py py-class docutils literal"><span class="pre">lino.modlib.cbss.models.IdentifyPersonResult</span></code> now includes address and
other fields that were still missing.
And the <cite>Default.odt</cite> now produces a printed result that seems usable.</p>
<p>CBSS-Requests dürfen weder verändert noch gelöscht werden, wenn sie einmal
abgeschickt wurden. Nicht einmal Systemverwalter dürfen das.
Bei der Gelegenheit habe ich noch weiter am &#8220;permission system&#8221; gearbeitet.
Wird Zeit, dass ich mal gewisse Ideen dokumentiere:</p>
<ul>
<li><p class="first">get_view_permission(elem,user) besagt, ob ein UI-Element überhaupt
<em>gesehen</em> werden kann.
Wenn nicht, dann wird der zum Anzeigen benötigte JS-Code gar nicht erst generiert.
<cite>elem</cite> kann ein <a class="reference external" href="http://www.lino-framework.org/api/lino.core.actors.html#lino.core.actors.Actor" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">lino.core.actors.Actor</span></code></a> sein,
aber auch z.B. ein <a class="reference external" href="http://www.lino-framework.org/api/lino.utils.jsgen.html#lino.utils.jsgen.Component" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">lino.utils.jsgen.Component</span></code></a>.
Bisher können alle Fälle ausschließlich durch Setzen von
<cite>required_user_groups</cite> und <cite>required_user_level</cite> geregelt werden, also die
Methode braucht von Anwendungscode nicht überschrieben zu werden.</p>
</li>
<li><p class="first">get_permission(actor,user,action) besagt, ob dieser User diese Aktion
bei diesem Aktor ausführen darf. Wird z.B. für den Insert-Button benutzt.</p>
</li>
<li><p class="first">get_row_permission(actor,action,user,row) besagt, ob dieser User diese Aktion
<em>auf diesem Objekt</em> (eine Zeile dieses Aktors) ausführen darf.
Diese Methode wird von Anwendungscode überschrieben, z.B. der
Button :guilabel:&#8221;Cache löschen&#8221; ist immer (ohne Wenn und Aber) disabled,
wenn das Dokument noch nie gedruckt wurde:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ClearCacheAction</span><span class="p">(</span><span class="n">actions</span><span class="o">.</span><span class="n">RowAction</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">get_row_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">build_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ClearCacheAction</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_row_permission</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><cite>disable_delete</cite> ist noch was Spezielles. Ist einerseits historisch bedingt,
hat aber auch damit zu tun, dass beim Verweigern des Löschens der User eine
Meldung mit der Begründung kriegen soll.
Also wenn man z.B. importierte Partner nicht löschen darf,
oder ein Objekt nicht löschen darf weil andere Objekte darauf verweisen,
dann hat das nichts mit Benutzerrechten zu tun. Der Löschen-Button ist
trotzdem aktiviert, und wenn man drauf klickt, kriegt man gesagt warum
man es trotzdem nicht darf.</p>
<p>Aber z.B. der Löschen-Button eines abgesendeten CBSSRequests ist jetzt richtig
disabled.</p>
</li>
</ul>
<p>Um die Änderungen auszuprobieren und zu veranschaulichen, habe ich
mal zwei Regeln implementiert, die eigentlich schon lange fällig waren:</p>
<ul>
<li><p class="first">Verträge (sowohl jobs.Contracts als auch isip.Contracts)
haben jetzt folgende Methode:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">get_row_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">action</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">row</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">integ_level</span> <span class="o">&lt;</span> <span class="n">UserLevel</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Contracts</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_row_permission</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="n">user</span><span class="p">,</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>Also normale Integrationsassistenten (Benutzer mit <cite>integ_level</cite> &lt;= <cite>UserLevel.manager</cite>)
dürfen jetzt nur noch ihre eigenen Verträge bearbeiten oder löschen.</p>
</li>
<li><p class="first">Idem für Termine und Aufgaben: hier muss man schon allgemeiner
Manager sein (<cite>level</cite> &lt;= <cite>UserLevel.manager</cite>),
um anderer Leute Termine bearbeiten oder löschen zu dürfen.</p>
</li>
</ul>
<p>Zum Beispiel darf Melanie (Manager von <cite>integ</cite>) die Verträge anderer Bentuzer löschen,
aber nicht deren Termine.</p>
<p><a class="reference external" href="http://code.google.com/p/lino/source/detail?r=a7c4efbe84c6">Checkin a7c4efbe84c6</a> wegen Feierabend.</p>
<p>Ein Detail war noch zu tun: Die Löschen-Aktion
(sowie alle anderen disabled_actions)
wird im Kontextmenü einer Grid-Ansicht noch nicht deaktiviert.
Deshalb ein neues SpecialStoreField
<code class="xref py py-class docutils literal"><span class="pre">lino.ui.extjs2.ext_store.DisabledActionsField</span></code>
und im generierten GridPanel eine Variable <cite>disabled_actions_index</cite>.
Und vor jedem Aktivieren des Kontextmenüs werden die Aktionen entsprechend dieses
Feldes aktiviert oder deaktiviert.</p>
<p>Converted field <cite>civil_state</cite> of <code class="xref py py-class docutils literal"><span class="pre">lino.apps.pcsw.models.Person</span></code>
to choicelist <code class="xref py py-class docutils literal"><span class="pre">lino.apps.pcsw.models.CivilState</span></code>.</p>
<p>The &#8220;Rebuild Site cache&#8221; button didn&#8217;t work. Fixed.</p>
<p>Lino now automatically rebuilds the user&#8217;s <code class="xref std std-xfile docutils literal"><span class="pre">lino*.js</span></code>
file when the user&#8217;s account has changed:</p>
<p>Removed the timestamp fields <cite>date_joined</cite> and <cite>last_login</cite>
from <a class="reference external" href="http://www.lino-framework.org/api/lino.modlib.users.models.html#lino.modlib.users.models.User" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">lino.modlib.users.models.User</span></code></a>
(anyway they weren&#8217;t used).
Added two fields <cite>created</cite> and <cite>modified</cite>
(from <a class="reference external" href="http://www.lino-framework.org/api/lino.mixins.html#lino.mixins.CreatedModified" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">lino.mixins.CreatedModified</span></code></a>).</p>
<p>Renamed <cite>auto_build_site_cache</cite> to
<code class="xref py py-attr docutils literal"><span class="pre">lino.Lino.never_build_site_cache</span></code>
(and inverted it&#8217;s meaning).</p>
<p>Wenn in einer Grid <em>zwei</em> obligatorische Combobox-Felder waren
(z.B. MemebersByHousehold),
dann konnte man dort nichts eingeben.
Weil immer nur das Hidden-Field der aktuellen Zelle gepostet wurde.
Behoben.</p>
<p>Eingabe eines Haushaltsbudgets funktioniert jetzt im Großen und Ganzen.
Nur der Drucken-Button ist nicht mehr da.
Danach muss ich morgen suchen, jetzt bin ich erstmal reif fürs Bett.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0601.html" title="20120601"
             >next</a> |</li>
        <li class="right" >
          <a href="0530.html" title="20120530"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2012</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2012/0531.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2012/0531.html">Online Link</a>
    </div>
  </body>
</html>