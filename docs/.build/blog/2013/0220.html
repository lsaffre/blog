<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20130220 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2013" href="index.html" />
    <link rel="next" title="20130221" href="0221.html" />
    <link rel="prev" title="20130219" href="0219.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0221.html" title="20130221"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0219.html" title="20130219"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2013</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20130220<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="why-django-needs-a-populated-signal">
<h2>Why Django needs a <cite>populated</cite> signal<a class="headerlink" href="#why-django-needs-a-populated-signal" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.lino-framework.org/api/lino.projects.homeworkschool.html#module-lino.projects.homeworkschool" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.projects.homeworkschool</span></code></a> had a problem with the new version,
caused by the Ross McFarland&#8217;s trick of having <a class="reference external" href="http://www.lino-framework.org/api/index.html#module-lino" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino</span></code></a> as the last installed_app
and calling <code class="xref py py-mod docutils literal"><span class="pre">lino.Lino.startup</span></code> automatically from <code class="xref py py-mod docutils literal"><span class="pre">lino.models</span></code>.</p>
<p>The problem is that
<a class="reference external" href="http://www.lino-framework.org/api/lino.projects.homeworkschool.html#module-lino.projects.homeworkschool" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.projects.homeworkschool</span></code></a> has apps which don&#8217;t import at first run.
The <cite>populate</cite> function in
<cite>django.db.models.loading</cite>
&#8220;postpones&#8221; them and gives them a second chance.</p>
<p>The order of installed applications is:</p>
<blockquote>
<div><div class="line-block">
<div class="line">...</div>
<div class="line"><code class="xref py py-mod docutils literal"><span class="pre">lino.modlib.school</span></code></div>
<div class="line">...</div>
<div class="line"><a class="reference external" href="http://www.lino-framework.org/api/lino.projects.homeworkschool.html#module-lino.projects.homeworkschool" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.projects.homeworkschool</span></code></a></div>
</div>
</div></blockquote>
<p>These two modules have the following interdependency:</p>
<ul class="simple">
<li><cite>homeworkschool</cite> defines the concrete implementation of <cite>contacts.Person</cite>
(which is declared in <code class="xref py py-attr docutils literal"><span class="pre">override_modlib_models</span></code>)</li>
<li><cite>school</cite> needs
the concrete implementation of <cite>contacts.Person</cite>
at module-level to define the <cite>Pupil</cite> and <cite>Teacher</cite> classes.</li>
</ul>
<p>This means that <cite>school</cite> will get postponed until <cite>homeworkschool</cite> has been loaded.</p>
<p>All the above is rather trivial, but it took me a lot of time to
understand the problem because of a &#8220;little bug&#8221;:</p>
<blockquote>
<div>The <code class="xref py py-func docutils literal"><span class="pre">resolve_model</span></code>
function may not use <cite>seed_cache=True</cite> (which causes Django
to populate the models cache before looking for the model)
since we want to have it usable at the top-level of <code class="docutils literal"><span class="pre">models</span></code>
modules.
Which is what <a class="reference external" href="http://www.lino-framework.org/api/lino.projects.homeworkschool.html#module-lino.projects.homeworkschool" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.projects.homeworkschool</span></code></a> did.
This caused a recursive populate, leading to very confusing error messages.</div></blockquote>
<p>Another piece of time went into finding out how to cope with this situation.
Which you can admire nor in <code class="xref py py-mod docutils literal"><span class="pre">lino.models</span></code>.</p>
<p>All this shows how regrettable it is that Django doesn&#8217;t provide a
<cite>populated</cite> signal.
It would be so easy,
just two lines of code in <cite>/django/db/models/loading.py</cite>
that wouldn&#8217;t hurt anybody:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">populated</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">Signal</span><span class="p">()</span> <span class="c"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; first line</span>

<span class="k">class</span> <span class="nc">AppCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nesting_level</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postponed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">populated</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>  <span class="c"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; second line</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">imp</span><span class="o">.</span><span class="n">release_lock</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="a-test-suite-for-watch-tim">
<h2>A test suite for <cite>watch_tim</cite><a class="headerlink" href="#a-test-suite-for-watch-tim" title="Permalink to this headline">¶</a></h2>
<p>A first bug in yesterday&#8217;s release occured. Here is my first reaction:</p>
<blockquote>
<div><p>Patsch, der erste Bug in der neuen Version: diese Fehlermeldung kommt,
wenn man in TIM einen Partner mit leerem PAR-&gt;IdUsr bearbeitet, der in
Lino als Klient existiert und noch keine Begleitungen hat... Im
vorliegenden Fall war es Partner Nummer 23633 (Kurt Sch.).</p>
<p>Die Unstabilität von watch_tim ist normal. Eigentlich müsste ich eine
ganze Latte von unit tests schreiben. Das ist technisch nicht sehr
kompliziert, würde aber viel Aufwand bedeuten, weil alle möglichen
Normal- und Sonderfälle darin vorkommen müssten. Angesichts der
Tatsache, dass watch_tim voraussichtlich bei euch schon bald
Vergangenheit ist und auch garantiert nie bei irgendeinem anderen
TIM-Benutzer jemals Verwendung finden wird finde ich, dass wir das
einfach aushalten müssen...</p>
</div></blockquote>
<p>After having written this, I nevertheless decided to start a unit test suite:
<code class="xref py py-mod docutils literal"><span class="pre">watchtim_tests</span></code>.</p>
<p>This took only 5 minutes, and at least this special case is now covered.
I won&#8217;t invest much energy into getting everything covered for the said
reasons, but who knows...</p>
</div>
<div class="section" id="a-propos-test-suite">
<h2>à propos test suite<a class="headerlink" href="#a-propos-test-suite" title="Permalink to this headline">¶</a></h2>
<p>Damit der obige Test in der Praxis taugt, müsste ich freilich erstmal
die Testsuite wieder aufpäppeln,
die ich in letzter Zeit vernachlässigt habe.
Also ran an den Speck. Jetzt oder nie.
Zumal ich vor dem Release heute abend sowieso
nichts großes Neues anfangen will.</p>
<p>Eine zeitraubende Sache war folgendes:
In einem Demo-Test (<code class="xref py py-func docutils literal"><span class="pre">test002</span></code>)
machte er eine Abfrage nach <cite>/api/cv/SoftSkillsByPerson</cite>.
Nun ist <code class="xref py py-class docutils literal"><span class="pre">SoftSkillsByPerson</span></code>
eine dynamische Tabelle, deren Titel und Inhalt von der SiteConfig abhängt.
Und die SiteConfig kriegt sinnvolle Werte erst wenn die Demo-Daten
eingelesen werden.
Wenn ich aber die gesamte Test-Suite laufen lasse,
wurde vorher
(<code class="xref py py-mod docutils literal"><span class="pre">quick_tests</span></code>)
schon das UI initialisiert, und zwar ohne Demo-Daten.
Und unsere dynamische Tabelle wurde natürlich nur ein einziges Mal pro Prozess
generiert: wenn man in den Site-Parametern eines der Felder
&#8220;Eigenschaftsgruppe Fähigkeiten&#8221;,
&#8220;Eigenschaftsgruppe Sozialkompetenzen&#8221;
oder
&#8220;Eigenschaftsgruppe Hindernisse&#8221;
verändert hätte, muss man anschließend den Server neustarten,
damit es aktiv wird.
So war das schon immer gewesen.
Wer will denn auch was Feineres.
Jawohl, unsere Testsuite will das.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0221.html" title="20130221"
             >next</a> |</li>
        <li class="right" >
          <a href="0219.html" title="20130219"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2013/0220.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2013/0220.html">Online Link</a>
    </div>
  </body>
</html>