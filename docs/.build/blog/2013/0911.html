<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20130911 (Wednesday, 11 September 2013) &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2013" href="index.html" />
    <link rel="next" title="20130912 (Thursday, 12 September 2013)" href="0912.html" />
    <link rel="prev" title="20130910 (Tuesday, 10 September 2013)" href="0910.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0912.html" title="20130912 (Thursday, 12 September 2013)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0910.html" title="20130910 (Tuesday, 10 September 2013)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2013</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="wednesday-11-september-2013">
<h1>20130911 (Wednesday, 11 September 2013)<a class="headerlink" href="#wednesday-11-september-2013" title="Permalink to this headline">¶</a></h1>
<p>I probably found an answer to my question &#8220;why did this error
pass the test suites and make it into a released version?&#8221;
(see <a class="reference external" href="oops">‘Site’ object has no attribute ‘modules’</a>).
Or rather how can I make an automated unit test.</p>
<p>Not really an automated unit test included within the standard test
suite, but I wrote a
new fab task <code class="docutils literal"><span class="pre">setup_test_sdist</span></code> in <a class="reference external" href="http://atelier.lino-framework.org/api/atelier.fablib.html#module-atelier.fablib" title="(in atelier v0.0)"><code class="xref py py-mod docutils literal"><span class="pre">atelier.fablib</span></code></a> which</p>
<ul class="simple">
<li>creates and activates a temporay virtualenv</li>
<li>calls <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">--extra-index</span> <span class="pre">X</span> <span class="pre">prjname</span></code>
(where X is your <cite>env.sdist_dir</cite>)</li>
<li>runs <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">test</span></code></li>
<li>tidies up</li>
</ul>
<p>This assumes that you previously did <code class="docutils literal"><span class="pre">pp</span> <span class="pre">fab</span> <span class="pre">sdist</span></code>
i.e. your <cite>env.sdist_dir</cite> contains the pre-release sdist of all your
projects.</p>
<div class="section" id="a-bug-in-account-full-clean">
<h2>A bug in <cite>Account.full_clean</cite><a class="headerlink" href="#a-bug-in-account-full-clean" title="Permalink to this headline">¶</a></h2>
<p>Gerd reported a bug:</p>
<blockquote>
<div>Ich bin ein Feintuning der Kopiervorlage der Budgets (Nr. 47) am machen.
Dabei fiel uns auf, dass ein Konto &#8220;Sonstige Transportkosten&#8221; (ID65)
fehlte. Das habe ich hinzugefügt.
Leider kann ich es nicht bei den Ausgaben der Kopiervorlage hinzufügen.
Es erscheint nicht in der Auswahlliste.
Ist das ein subtiler Bug oder mache ich einen Fehler?</div></blockquote>
<p>Indeed this was a bug in <cite>Account.full_clean</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">full_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">account_type</span>
</pre></div>
</div>
<p>This must be:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">full_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">account_type</span>
</pre></div>
</div>
<p>The <cite>type</cite> of an Account should always have the same value as
the Account&#8217;s <cite>group.account_type</cite>.</p>
<p>The test suite now passes.</p>
<p>Continued on <a class="reference external" href="http://faggio.lino-framework.org/index.html#faggio" title="(in Lino Faggio Reference v0.0)"><span>Lino Faggio</span></a>.</p>
<p>In <a class="reference external" href="http://www.lino-framework.org/api/lino.core.actions.html#lino.core.actions.Action" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">lino.core.actions.Action</span></code></a> we had until now:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">icon_name</span> <span class="o">=</span> <span class="s">&#39;x-tbar-new&#39;</span> <span class="c"># if action rendered as toolbar button</span>
<span class="n">icon_file</span> <span class="o">=</span> <span class="s">&#39;add.png&#39;</span> <span class="c"># if action rendered by quick_add_buttons</span>
</pre></div>
</div>
<p>Replaced this by:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">icon_name</span> <span class="o">=</span> <span class="s">&#39;add&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="slave-grids-filled-with-nonsense-data-when-opening-a-detail-for-the-first-time">
<h2>Slave grids filled with nonsense data when opening a Detail for the first time<a class="headerlink" href="#slave-grids-filled-with-nonsense-data-when-opening-a-detail-for-the-first-time" title="Permalink to this headline">¶</a></h2>
<p>While working on the todo list of <a class="reference external" href="http://faggio.lino-framework.org/index.html#faggio" title="(in Lino Faggio Reference v0.0)"><span>Lino Faggio</span></a>
I stumbled over a particularily easy reproduction
of our well known Javascript bug:
Simply load the
permalink <a class="reference external" href="http://127.0.0.1:8000/api/contacts/Persons/114?an=detail&amp;tab=2">http://127.0.0.1:8000/api/contacts/Persons/114?an=detail&amp;tab=2</a>
and the Movements grid was filled.</p>
<p>The obvious reason was that these slave grids
loaded themselves while URL_PARAMS_MASTER_PK was still empty.
A Grid loads itself when the view is ready:</p>
<div class="highlight-python"><div class="highlight"><pre>Lino.GridPanel did this::

    this.on(&#39;viewready&#39;, function(){
      this.view_is_ready = true;
      this.refresh();
      },this);
</pre></div>
</div>
<p>And for slave grids this can happen <em>before the request for the master
record had completed</em>.</p>
<p>Solution: I added a simple test in the
<cite>GridPanel.refresh_with_after</cite> method:</p>
<div class="highlight-python"><div class="highlight"><pre>if (this.containing_panel) {
    ...
    if (!this.store.baseParams.{{ext_requests.URL_PARAM_MASTER_PK}}) {
        return;
    }
}
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0912.html" title="20130912 (Thursday, 12 September 2013)"
             >next</a> |</li>
        <li class="right" >
          <a href="0910.html" title="20130910 (Tuesday, 10 September 2013)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2015 Luc Saffre.
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
    <a href="https://raw.github.com/lsaffre/blog/master/docs/blog/2013/0911.rst"
           rel="nofollow">Show Source</a>.
    <a href="http://luc.lino-framework.org/blog/2013/0911.html">Online Link</a>
    </div>
  </body>
</html>