<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20130221 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2013" href="index.html" />
    <link rel="next" title="20130222" href="0222.html" />
    <link rel="prev" title="20130220" href="0220.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0222.html" title="20130222"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0220.html" title="20130220"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2013</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20130221<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="unit-testing-produces-problems">
<h2>Unit testing produces problems<a class="headerlink" href="#unit-testing-produces-problems" title="Permalink to this headline">¶</a></h2>
<p>The release with yesterday&#8217;s small bugfixes was almost ready:</p>
<ul class="simple">
<li>Release notes:
<a class="reference external" href="http://www.lino-framework.org/releases/1.5.10.html">Lino 1.5.1</a>
<a class="reference external" href="http://welfare.lino-framework.org/releases/1.0.13.html">Welfare 1.0.13</a></li>
</ul>
<p>But there was time left before the evening, so I started to clean up
the test suite. This included a series of little internal optimizations
in the startup process (details see yesterday (German only).
Everything seemed fine and innocent until I deployed it
on the <cite>lino-framework.org</cite> server:
some strange failures, probably due to threading issues.
Finally these small optimizations I made for the
test suite had triggered an avalanche of changes,
each of them very welcome and probably making Lino better
in the long run... but not really at the right moment.
Of course these surprises disturb my release process only because
I don&#8217;t use branching as I should...</p>
<p>Anyway, these problems are solved in
<a class="reference external" href="http://code.google.com/p/lino/source/detail?r=18584dc2ff18">Checkin 18584dc2ff18</a>.</p>
<p>And still I&#8217;ll spend the rest of today on the unit tests
(because the long-term advantages are more important than the short-term risk)
and without a branch (because branching does cost some &#8220;administrative&#8221;
overhead, and because I&#8217;d rather enjoy my freedom as long as I am the
only Lino developer).</p>
<p>Insgesamt wird der Startup-Vorgang durch die gestrigen Änderungen
geradliniger und klarer.
Einer der kleinen Nebeneffekte ist, dass die SiteConfig-Instanz jetzt schon gleich
beim Startup eingelesen und gecacht wird.
Was zu einem coolen Bug führte: in
<code class="xref py py-mod docutils literal"><span class="pre">initdb</span></code>
und auch
<a class="reference external" href="http://www.lino-framework.org/api/lino.management.commands.initdb_demo.html#module-lino.management.commands.initdb_demo" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">initdb</span></code></a>
führte das zu einem Problem, das nur jedes zweite Mal auftrat:
wenn die Datenbank von einem vorigen Lauf noch initialisiert war,
enthielt die SiteConfig Verweise auf andere Objekte wie den Sektor, job_agent usw.
Aber die wurden ja dann gelöscht.
Und wenn dumppy die gecachte SiteConfig dann speicheren wollte,
bekam er bein full_clean einen ValidationError.</p>
</div>
<div class="section" id="lino-startup-in-multi-threaded-environment">
<h2>Lino startup in multi-threaded environment<a class="headerlink" href="#lino-startup-in-multi-threaded-environment" title="Permalink to this headline">¶</a></h2>
<p>I spent another hour to document a problem which took me a few hours to understand.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Trying to explain the problem that occured today.</span>

<span class="sd">Thanks to http://www.dabeaz.com/python/UnderstandingGIL.pdf</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>

<span class="k">class</span> <span class="nc">Lino</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">doing</span> <span class="o">=</span> <span class="bp">False</span>
        
    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>  <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doing</span><span class="p">:</span>
            <span class="c">#~ raise Exception(&quot;doing&quot;)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doing</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="c"># simulate a big work to do before the `ui` attribute can be added</span>
        <span class="k">print</span> <span class="s">&quot;Starting up&quot;</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="k">print</span> <span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="p">;</span> <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;. done&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="s">&quot;yes&quot;</span>
          
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doing</span> <span class="o">=</span> <span class="bp">False</span>
        
<span class="c"># A Django process has one global Lino instance in `settings.LINO`.</span>
<span class="n">LINO</span> <span class="o">=</span> <span class="n">Lino</span><span class="p">()</span> 

<span class="c"># Parameters to play with:</span>
<span class="n">SINGLE_THREADED</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># multi-threaded, e.g. mod_wsgi</span>
<span class="c">#~ SINGLE_THREADED = True # single threaded, e.g. development server</span>
<span class="c">#~ WAIT_BEFORE_ACCESSING_UI = 0</span>
<span class="n">WAIT_BEFORE_ACCESSING_UI</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Incoming </span><span class="si">%s</span><span class="s">:&quot;</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">LINO</span><span class="o">.</span><span class="n">startup</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">WAIT_BEFORE_ACCESSING_UI</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">WAIT_BEFORE_ACCESSING_UI</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">LINO</span><span class="o">.</span><span class="n">ui</span>
    

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;SINGLE_THREADED is </span><span class="si">%s</span><span class="s">, WAIT_BEFORE_ACCESSING_UI is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SINGLE_THREADED</span><span class="p">,</span> <span class="n">WAIT_BEFORE_ACCESSING_UI</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SINGLE_THREADED</span><span class="p">:</span> 
        <span class="n">main</span><span class="p">(</span><span class="s">&#39;request1&#39;</span><span class="p">)</span>
        <span class="n">main</span><span class="p">(</span><span class="s">&#39;request2&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># We simulate what mod_wsgi does:</span>
        <span class="c"># Each incoming http request starts a new thread.</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">main</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;request1&#39;</span><span class="p">,))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">main</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;request2&#39;</span><span class="p">,))</span>
        <span class="n">t1</span><span class="o">.</span><span class="n">start</span><span class="p">();</span> <span class="n">t2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">t1</span><span class="o">.</span><span class="n">join</span><span class="p">();</span> <span class="n">t2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    
</pre></div>
</div>
<p>Constellation 1 is on a development server:</p>
<div class="highlight-python"><div class="highlight"><pre>SINGLE_THREADED is True, WAIT_BEFORE_ACCESSING_UI is 0
Incoming request1:
Starting up . . . . done
yes
Incoming request2:
</pre></div>
</div>
<p>Constellation 2 on a mod_wsgi until yesterday:</p>
<div class="highlight-python"><div class="highlight"><pre>SINGLE_THREADED is False, WAIT_BEFORE_ACCESSING_UI is 2
Incoming request1:
Starting up . Incoming request2:
. . . done
yes
yes
</pre></div>
</div>
<p>Constellation 3 on a mod_wsgi after yesterday:</p>
<div class="highlight-python"><div class="highlight"><pre>SINGLE_THREADED is False, WAIT_BEFORE_ACCESSING_UI is 0
Incoming request1:
Starting up . Incoming request2:
Exception in thread Thread-2:
Traceback (most recent call last):
  File &quot;c:\Python27\lib\threading.py&quot;, line 530, in __bootstrap_inner
    self.run()
  File &quot;c:\Python27\lib\threading.py&quot;, line 483, in run
    self.__target(*self.__args, **self.__kwargs)
  File &quot;0221.py&quot;, line 49, in main
    print LINO.ui
AttributeError: &#39;Lino&#39; object has no attribute &#39;ui&#39;

. . . done
yes
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0222.html" title="20130222"
             >next</a> |</li>
        <li class="right" >
          <a href="0220.html" title="20130220"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">

<a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/2.5/88x31.png" /></a>
This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 Generic License</a>.<br />
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
<a href="../../_sources/blog/2013/0221.txt">Show Source</a> 
    <a href="http://luc.lino-framework.org/blog/2013/0221.html">Online Link</a>
    </div>
  </body>
</html>