<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20130301 &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2013" href="index.html" />
    <link rel="next" title="20130302" href="0302.html" />
    <link rel="prev" title="20130228" href="0228.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0302.html" title="20130302"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0228.html" title="20130228"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2013</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>20130301<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="contacts-quicktest-failed-sometimes">
<h2><cite>contacts.QuickTest</cite> failed sometimes<a class="headerlink" href="#contacts-quicktest-failed-sometimes" title="Permalink to this headline">¶</a></h2>
<p>Gestern abend hatte ich das hier bemerkt:</p>
<ul class="simple">
<li><cite>contacts.QuickTest</cite> fails when called for a Lino-Welfare site.</li>
</ul>
<p>Das war subtil.
Lag daran, dass <a class="reference external" href="http://welfare.lino-framework.org/api/lino_welfare.modlib.cv.html#module-lino_welfare.modlib.cv" title="(in Lino Welfare Reference Manual v1.1)"><code class="xref py py-mod docutils literal"><span class="pre">lino_welfare.modlib.cv</span></code></a>
folgendes machte, um die Titel der drei Tabellen
&#8220;Fähigkeiten&#8221;, &#8220;Sozialkompetenzen&#8221; und &#8220;Hindernisse&#8221; zu setzen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">after_site_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ConfiguredPropsByPerson</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">after_site_setup</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propgroup_config_name</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="n">sc</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="n">adapt</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">site_config</span><span class="p">)</span>

        <span class="o">...</span>
</pre></div>
</div>
<p>Da wurde also während <code class="xref py py-meth docutils literal"><span class="pre">lino.Lino.startup()</span></code>
auf <code class="xref py py-attr docutils literal"><span class="pre">lino.Lino.site_config</span></code> zugegriffen.
Logisch, denn diese drei Tabellen hängen nun mal davon ab,
was man in der SiteConfig angegeben hat.</p>
<p>Lino versucht da also die <cite>SiteConfig</cite> zu laden:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">site_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_config</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">lino.core.modeltools</span> <span class="kn">import</span> <span class="n">resolve_model</span>
        <span class="n">SiteConfig</span> <span class="o">=</span> <span class="n">resolve_model</span><span class="p">(</span><span class="s">&#39;ui.SiteConfig&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="kn">import</span> <span class="n">DatabaseError</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_site_config</span> <span class="o">=</span> <span class="n">SiteConfig</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SiteConfig</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span><span class="n">DatabaseError</span><span class="p">):</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_config_defaults</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_site_config</span> <span class="o">=</span> <span class="n">SiteConfig</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_config</span>
</pre></div>
</div>
<p>Bei einem <code class="docutils literal"><span class="pre">manage.py</span> <span class="pre">test</span></code> gelang ihm das <em>manchmal</em>,
und zwar dann, wenn zufällig momentan eine echte Datenbank existierte.
Dann hatte er das Objekt im Cache drin, aber kurz danach
wurde die echte Datenbank abgemeldet, um die Testdatenbank
anzumelden und zu erstellen.</p>
<p>Besonders witzig war, dass es dann nicht sofort und überhaupt gar nicht immer knallte.
Es knallte z.B., wenn ein Test dann auf <cite>settings.LINO.site_config.site_company</cite> zugriff.
Dann versuchte Django, die <cite>site_company</cite> aus der Datenbank zu holen, deren <cite>primary key</cite>
er sich zuvor selber notiert hatte. Und dann merkte er, dass eine Company mit
diesem pk nicht existierte.</p>
<p>Eine erste Lösung bestand darin, nach jedem <cite>connection_created</cite>
den cache zu löschen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@dd.receiver</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">connection_created</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">LINO</span><span class="o">.</span><span class="n">clear_site_config</span><span class="p">()</span>
</pre></div>
</div>
<p>Aber das war doch recht unelegant:
zufällige Daten einlesen, nur das Ganze dann wieder rückgängig zu machen?</p>
<p>Nein, da ändern wir doch besser die obige <cite>after_site_setup</cite>,
so dass diese Funktion <cite>adapt</cite> nicht sofort sondern
nach jedem <cite>connection_created</cite> gerufen wird:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">after_site_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">site</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">ConfiguredPropsByPerson</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">after_site_setup</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propgroup_config_name</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">adapt</span><span class="p">(</span><span class="n">sc</span><span class="p">):</span>
            <span class="o">...</span>
        <span class="nd">@dd.receiver</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">connection_created</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">my_callback</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">adapt</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINO</span><span class="o">.</span><span class="n">site_config</span><span class="p">)</span>

        <span class="o">...</span>
</pre></div>
</div>
<p>Jetzt brauchen wir auch nicht mehr den DatabaseError abzufangen
in der property <code class="xref py py-attr docutils literal"><span class="pre">site_config</span></code>.
Cool! Lino ist mal wieder schöner geworden.</p>
</div>
<div class="section" id="expected-parenthesized-list">
<h2>expected parenthesized list<a class="headerlink" href="#expected-parenthesized-list" title="Permalink to this headline">¶</a></h2>
<p>I had the following line in my setup.py:</p>
<div class="highlight-python"><div class="highlight"><pre>requires = [... &#39;python-dateutil&#39;...],
</pre></div>
</div>
<p>That was wrong, it must be:</p>
<div class="highlight-python"><div class="highlight"><pre>requires = [... &#39;python_dateutil&#39;...],
</pre></div>
</div>
<p>Here is how Distribute told me this:</p>
<div class="highlight-python"><div class="highlight"><pre>python setup.py sdist --formats=gztar,zip --dist-dir=docs/dl
Traceback (most recent call last):
  File &quot;setup.py&quot;, line 47, in &lt;module&gt;
    Topic :: Software Development :: Libraries :: Application Frameworks&quot;&quot;&quot;.splitlines())
  File &quot;C:\Python27\lib\distutils\core.py&quot;, line 112, in setup
    _setup_distribution = dist = klass(attrs)
  File &quot;C:\Python27\lib\site-packages\distribute-0.6.35-py2.7.egg\setuptools\dist.py&quot;, line 225, in __init__
    _Distribution.__init__(self,attrs)
  File &quot;C:\Python27\lib\distutils\dist.py&quot;, line 259, in __init__
    getattr(self.metadata, &quot;set_&quot; + key)(val)
  File &quot;C:\Python27\lib\distutils\dist.py&quot;, line 1220, in set_requires
    distutils.versionpredicate.VersionPredicate(v)
  File &quot;C:\Python27\lib\distutils\versionpredicate.py&quot;, line 113, in __init__
    raise ValueError(&quot;expected parenthesized list: %r&quot; % paren)
ValueError: expected parenthesized list: &#39;-dateutil&#39;
make: *** [sdist] Error 1
</pre></div>
</div>
</div>
<div class="section" id="release">
<h2>Release<a class="headerlink" href="#release" title="Permalink to this headline">¶</a></h2>
<p>Und jetzt kann ich die neuen Versionen für
<a class="reference external" href="http://welfare.lino-framework.org/releases/1.0.16.html">Lino-Welfare</a>
und <a class="reference external" href="http://www.lino-framework.org/releases/1.5.13.html">Lino</a> rauslassen und installieren.
Genau rechtzeitig zum Amtsantritt des neuen Präsidenten.
Willkommen im ÖSHZ, Lambert Jaegers!
Wir kennen uns noch nicht persönlich, aber ich freue mich,
dass jetzt ein Ecolo-Geist mitredet.</p>
</div>
<div class="section" id="new-naming-ideas">
<h2>New naming ideas<a class="headerlink" href="#new-naming-ideas" title="Permalink to this headline">¶</a></h2>
<p>Continued to think on <a class="reference external" href="https://github.com/lsaffre/lino/blob/master/docs/tickets/74">docs/tickets/74</a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About me</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0302.html" title="20130302"
             >next</a> |</li>
        <li class="right" >
          <a href="0228.html" title="20130228"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2015 Luc Saffre.
      Last updated on 2015-03-31.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
    <a href="https://raw.github.com/lsaffre/blog/master/docs/blog/2013/0301.rst"
           rel="nofollow">Show Source</a>.
    <a href="http://luc.lino-framework.org/blog/2013/0301.html">Online Link</a>
    </div>
  </body>
</html>