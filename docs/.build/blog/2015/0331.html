<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>20150331 (Tuesday, 31 March 2015) &mdash; Luc&#39;s website</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/centeredlogo.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/taglist_tags.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Luc&#39;s website"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="Luc&#39;s website" href="../../index.html" />
    <link rel="up" title="2015" href="index.html" />
    <link rel="next" title="Wednesday, April 1, 2015" href="0401.html" />
    <link rel="prev" title="Monday, March 30, 2015" href="0330.html" />
   
<script src="../../.htmldata/lightbox/js/jquery-1.11.0.min.js"></script>
<script src="../../.htmldata/lightbox/js/lightbox.min.js"></script>
<link href="../../.htmldata/lightbox/css/lightbox.css" rel="stylesheet" />

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="0401.html" title="Wednesday, April 1, 2015"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="0330.html" title="Monday, March 30, 2015"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">2015</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="tuesday-31-march-2015">
<h1>20150331 (Tuesday, 31 March 2015)<a class="headerlink" href="#tuesday-31-march-2015" title="Permalink to this headline">¶</a></h1>
<div class="section" id="a-calendar-navigator-for-my-blog">
<h2>A calendar navigator for my blog<a class="headerlink" href="#a-calendar-navigator-for-my-blog" title="Permalink to this headline">¶</a></h2>
<p>I spent two hours with optimizing <a class="reference external" href="http://atelier.lino-framework.org/api/atelier.sphinxconf.blog.html#module-atelier.sphinxconf.blog" title="(in atelier v0.0)"><code class="xref py py-mod docutils literal"><span class="pre">atelier.sphinxconf.blog</span></code></a>.  My
blog now features an automatic calendar navigator. I just wanted to
move the old years to a less visible place without loosing them from
the global toctree.  This blogging system contains blog entries since
2009 (though the first years were originally written in other formats
and are not yet fully converted)</p>
</div>
<div class="section" id="repairing-data-using-a-script">
<h2>Repairing data using a script<a class="headerlink" href="#repairing-data-using-a-script" title="Permalink to this headline">¶</a></h2>
<p>Yesterday we decided to write and run a rather simple but critical
batch operation in a production database.</p>
<p>Here is the script shortly before I actually ran it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">lino.api.shell</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">clint.textui</span> <span class="kn">import</span> <span class="n">puts</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">lino.core.utils</span> <span class="kn">import</span> <span class="n">PseudoRequest</span><span class="p">,</span> <span class="n">ChangeWatcher</span>

<span class="c"># rt.show(pcsw.ClientStates)</span>
<span class="c"># rt.show(changes.Changes)</span>

<span class="n">former</span> <span class="o">=</span> <span class="n">pcsw</span><span class="o">.</span><span class="n">ClientStates</span><span class="o">.</span><span class="n">former</span>
<span class="c"># refused = pcsw.ClientStates.refused</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">pcsw</span><span class="o">.</span><span class="n">Coaching</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">client__client_state</span><span class="o">=</span><span class="n">former</span><span class="p">,</span> <span class="n">end_date__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c"># qs = pcsw.Coaching.objects.filter(client__client_state=former)</span>

<span class="n">puts</span><span class="p">(</span><span class="s">&quot;{0} unbeendete Begleitungen ehemaliger Klienten&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()))</span>

<span class="n">clients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">progress</span><span class="o">.</span><span class="n">dots</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="n">puts</span><span class="p">(</span><span class="s">&quot;{0} Klienten&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span>
<span class="n">puts</span><span class="p">(</span><span class="s">&quot;Davon Klienten mit mehr als einer Begleitung:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">clients</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;- {0} : {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">user</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]))</span>

<span class="n">ok</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">&quot;Ready to go?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">ok</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="p">:</span>

    <span class="n">REQUEST</span> <span class="o">=</span> <span class="n">PseudoRequest</span><span class="p">(</span><span class="s">&quot;robin&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">progress</span><span class="o">.</span><span class="n">dots</span><span class="p">(</span><span class="n">qs</span><span class="p">):</span>
        <span class="n">cw</span> <span class="o">=</span> <span class="n">ChangeWatcher</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">modified</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">cw</span><span class="o">.</span><span class="n">send_update</span><span class="p">(</span><span class="n">REQUEST</span><span class="p">)</span>

<span class="c"># rt.show(changes.Changes)</span>
</pre></div>
</div>
<p>I discovered that the <cite>puts</cite> of <a class="reference external" href="https://pypi.python.org/pypi/clint/">clint</a> does not like unicode
strings. What a pity! I also saw that <a class="reference external" href="https://github.com/kennethreitz/clint/issues/48">they know it</a>.</p>
<p>I wrote documentation for <a class="reference external" href="http://www.lino-framework.org/api/lino.core.utils.html#lino.core.utils.PseudoRequest" title="(in Lino v1.6)"><code class="xref py py-class docutils literal"><span class="pre">PseudoRequest</span></code></a> and moved it from <a class="reference external" href="http://www.lino-framework.org/api/lino.api.dd.html#module-lino.api.dd" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.api.dd</span></code></a>
to <a class="reference external" href="http://www.lino-framework.org/api/lino.core.utils.html#module-lino.core.utils" title="(in Lino v1.6)"><code class="xref py py-mod docutils literal"><span class="pre">lino.core.utils</span></code></a>.</p>
</div>
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<p>I updated some parts of the Lino documentation.</p>
</div>
<div class="section" id="about-plugin-inheritance">
<h2>About plugin inheritance<a class="headerlink" href="#about-plugin-inheritance" title="Permalink to this headline">¶</a></h2>
<p>The new module <code class="xref py py-mod docutils literal"><span class="pre">lino_welfare.modlib.countries</span></code> is because I
converted the usage of <a class="reference external" href="http://www.lino-framework.org/api/lino.core.actors.html#lino.core.actors.Actor.set_detail_layout" title="(in Lino v1.6)"><code class="xref py py-meth docutils literal"><span class="pre">set_detail_layout</span></code></a> and of the magic
<cite>site_setup</cite> function which were in <a class="reference external" href="http://welfare.lino-framework.org/api/lino_welfare.models.html#module-lino_welfare.models" title="(in Lino Welfare Reference Manual v1.1)"><code class="xref py py-mod docutils literal"><span class="pre">lino_welfare.models</span></code></a>.</p>
<p>My plan is to declare this usage pattern as deprecated, but the topic
needs more investigation and documentation.</p>
<p>I also tried to solve the problem that a plugin, when it inherits from
an existing plugin, must create a wrapper for everything in its
parent&#8217;s <cite>fixtures</cite> and <cite>config</cite> directories.  That problem is
described in <code class="xref doc docutils literal"><span class="pre">/dev/plugin_inheritance</span></code>.  My idea was to add
<cite>fixtures</cite> directories of parent plugins to Django&#8217;s
<code class="xref std std-setting docutils literal"><span class="pre">FIXTURE_DIR</span></code> setting. I even got this wo work, but then
discovered that it is useless because it changes the order in which
the fixtures are being loaded: Django&#8217;s loaddata command first loads
all fixtures of <a class="reference external" href="http://www.lino-framework.org/ref/settings.html#setting-INSTALLED_APPS" title="(in Lino v1.6)"><code class="xref std std-setting docutils literal"><span class="pre">INSTALLED_APPS</span></code></a>, and only then those from
<code class="xref std std-setting docutils literal"><span class="pre">FIXTURE_DIR</span></code>. No, I think we must continue to live with these
fixture wrappers.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/logo.png" alt="Logo"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Blog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">Luc Saffre</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><p align="center">
<a href="https://github.com/lsaffre" target="_blank">GitHub</a>
<br/><a href="http://www.lino-framework.org" target="_blank">Lino</a>
<br/><a href="http://www.saffre-rumma.net" target="_blank">Rumma & Ko</a>
</p>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="0401.html" title="Wednesday, April 1, 2015"
             >next</a> |</li>
        <li class="right" >
          <a href="0330.html" title="Monday, March 30, 2015"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Blog</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >2015</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2015 Luc Saffre.
      Last updated on 2015-04-01.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.
    <a href="https://raw.github.com/lsaffre/blog/master/docs/blog/2015/0331.rst"
           rel="nofollow">Show Source</a>.
    <a href="http://luc.lino-framework.org/blog/2015/0331.html">Online Link</a>
    </div>
  </body>
</html>